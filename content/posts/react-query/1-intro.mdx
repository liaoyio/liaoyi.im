---
title: è§£å†³å‰ç«¯è¯·æ±‚çŠ¶æ€ç®¡ç†å›°å¢ƒ â€”â€” react-query ç®€ä»‹
description: æœ¬æ–‡ä»‹ç»æˆ‘ä»¬åœ¨å‰ç«¯å¼€å‘ä¸­è¯·æ±‚ç½‘ç»œæ•°æ®æ—¶é¢ä¸´çš„ä¸€äº›å›°å¢ƒï¼Œä»¥åŠä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ react-queryã€‚
date: 2025-05-22
tags: ['react-query', 'å¼‚æ­¥çŠ¶æ€ç®¡ç†']
author: liaoyi
series: react-query
seriesPart: 1
---

## å‰è¨€
åœ¨å¼€å§‹å‰ï¼Œæˆ‘æƒ³è®¨è®ºä¸€ä¸‹æ ‡é¢˜ä¸­è¯´çš„ **è¯·æ±‚çŠ¶æ€ç®¡ç†å›°** æ˜¯ä»€ä¹ˆï¼Ÿ

### è¿‡äºç®€æœ´çš„ `fetch` è¯·æ±‚

åœ¨ä½¿ç”¨åŸç”Ÿçš„ `fetch api` è·å–æ•°æ®æ—¶ï¼Œå¤§å®¶é€šå¸¸ä¼šè¿™ä¹ˆå†™ã€‚

```tsx
useEffect(() => {
  fetch('https://api.example.com/students')
    .then((res) => res.json())
    .then((data) => {
      setStudents(data)
    })
}, [])
```

<Callout type='warn'>
ä¸Šé¢è¿™æ®µä»£ç è™½ç„¶å¾ˆç®€æ´ï¼Œä½†è¿™ç§å†™æ³•åªèƒ½åœ¨ `demo` é‡Œä½¿ç”¨ã€‚
</Callout>


åœ¨çœŸæ­£çš„ç”Ÿäº§ç¯å¢ƒä¸­è¿™ä¹ˆå†™æ˜¯ä¸èƒ½æ¥å—çš„ã€‚å› ä¸ºä½ å¯¹è¿™ä¸ªè¯·æ±‚æ²¡æœ‰åšä»»ä½•å¤„ç†ï¼Œå®ƒçš„æˆåŠŸä¸å¦è¢«å®Œå…¨çš„~~æ”¾ä»»è‡ªç”±~~è‡ªæ±‚å¤šç¦äº†ã€‚æ¢å¥è¯è¯´ï¼Œè¿™ä¸ªé¡µé¢èƒ½å¦æ­£å¸¸å·¥ä½œä¹Ÿè¢«æ”¾ä»»è‡ªç”±äº†ã€‚

è¿™ä¹ˆåšä¼šå¸¦æ¥ä¸€äº›è‡´å‘½é—®é¢˜ï¼š


<Callout type='warn'>
ä¸€æ—¦ `loading` æ—¶é—´è¿‡é•¿å´æ²¡æœ‰ä»»ä½•åé¦ˆã€æˆ–è€…è¯·æ±‚å‡ºé”™äº†ä½†å‰ç«¯æ²¡æœ‰ä»»ä½•å“åº”ï¼Œå¯¹ç”¨æˆ·ä½“éªŒæ¥è¯´éƒ½æ˜¯è‡´å‘½æ‰“å‡»ã€‚
</Callout>


### è¿‡äºç¹ççš„çŠ¶æ€å¤„ç†

æ‰€ä»¥åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¼šå†æ·»åŠ  `loading` å’Œé”™è¯¯å¤„ç†é€»è¾‘ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```tsx  title="ä¸€ä¸ªç®€å•çš„è·å–å­¦ç”Ÿåˆ—è¡¨çš„ç»„ä»¶"

const StudentList = () => {

  const [students, setStudents] = useState([])
  const [isLoading, setIsLoading] = useState(true)
  const [error, setError] = useState(null)

  // ç»„ä»¶æŒ‚è½½æ—¶è·å–æ•°æ®
  useEffect(() => {
    const fetchStudents = async () => {
      try {
        setIsLoading(true)
        const response = await fetch('https://api.example.com/students')
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`)
        }
        const data = await response.json()
        setStudents(data)
      } catch (err) {
        setError(err instanceof Error ? err : new Error('å‘ç”ŸæœªçŸ¥é”™è¯¯'))
      } finally {
        setIsLoading(false)
      }
    }

    fetchStudents()
  }, [])

  // åŠ è½½çŠ¶æ€æ˜¾ç¤º
  if (isLoading) {
    return <div>åŠ è½½ä¸­...</div>
  }

  // é”™è¯¯çŠ¶æ€æ˜¾ç¤º
  if (error) {
    return <div>å‘ç”Ÿé”™è¯¯: {error.message}</div>
  }

  return (
    <ul>
      {students.map((student) => (
        <li key={student.id}>
          <p>å§“å: {student.name}</p>
          <p>å¹´é¾„: {student.age}</p>
          <p>æ€§åˆ«: {student.gender}</p>
        </li>
      ))}
    </ul>
  )
}
```

ä»ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¼•å‘å‡ºçš„æ€è€ƒğŸ¤”ï¼š

- æˆ‘ä»¬åªæ˜¯ä¸ºäº†å¤„ç†ä¸€ä¸ªç½‘ç»œè¯·æ±‚çš„è¡ç”Ÿé€»è¾‘ï¼Œä½†ä»£ç å·²ç»å¼€å§‹å˜å¾—å¤æ‚åŒ–ï¼Œæ¨¡æ¿åŒ–äº†ã€‚
- `isLoading`ï¼Œ`error`ï¼Œè¿™äº›è¡ç”ŸçŠ¶æ€éƒ½éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨ç®¡ç†ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½è¿™ä¹ˆå†™æ˜¾ç„¶å¾ˆéº»çƒ¦ã€‚


### ç«æ€é—®é¢˜

å¦ä¸€ä¸ªå¸¸è§ä½†å¯èƒ½è¢«å¿½è§†çš„åœºæ™¯æ˜¯ç«æ€é—®é¢˜ï¼šåœ¨å‘é€å¤šä¸ªç›¸ä¼¼çš„è¯·æ±‚æ—¶ï¼Œç”±äºæˆ‘ä»¬ä¸çŸ¥é“å“ªä¸€ä¸ªè¯·æ±‚å…ˆå®Œæˆï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ä¿è¯æœ€ç»ˆæ¸²æŸ“çš„æ˜¯å¦æ˜¯æœ€åä¸€æ¬¡è¯·æ±‚ç»“æœã€‚

ä¸Šè¿°æœ‰ç‚¹æŠ½è±¡ï¼Œæˆ‘ä»¬æƒ³è±¡ä¸¤ä¸ªåœºæ™¯ï¼š

1. **ç¿»é¡µäº¤äº’**ï¼šæœ‰ä¸€ä¸ªæ”¯æŒç¿»é¡µçš„è¡¨æ ¼ï¼Œå¦‚æœç”¨æˆ·ä»ç¬¬ä¸€é¡µå¿«é€Ÿçš„ç¿»åˆ°ç¬¬åé¡µã€‚æ­¤æ—¶ç”¨æˆ·æœŸæœ›çœ‹åˆ°çš„æ˜¯ç¬¬åé¡µçš„æ•°æ®ï¼Œä½†æˆ‘ä»¬ä¸èƒ½ä¿è¯ç¬¬åé¡µçš„è¯·æ±‚ä¸€å®šæ—©äºå…¶ä»–é¡µç çš„è¯·æ±‚è¿”å›ï¼Œæ‰€ä»¥ç¬¬åé¡µçš„è¯·æ±‚ç»“æœå¯èƒ½è¢«å…¶ä»–é¡µç çš„è¯·æ±‚ç»“æœè¦†ç›–ã€‚

2. **æœç´¢åŠŸèƒ½**ï¼šä¸€ä¸ªè‡ªåŠ¨å®Œæˆç»„ä»¶ï¼Œç”¨æˆ·è¾“å…¥ä¸€éƒ¨åˆ†å†…å®¹ï¼Œç»„ä»¶ä¼šç«‹å³è®¿é—®è¿œç¨‹æœåŠ¡å™¨è·å–æ™ºèƒ½è¡¥å…¨çš„æç¤ºè¯ã€‚ä½†å› ä¸ºç”¨æˆ·è¾“å…¥å˜æ›´å¾ˆå¿«ï¼Œæœ€ç»ˆæ˜¾ç¤ºçš„æç¤ºè¯å¯èƒ½è¢«å»¶æœŸè¿”å›çš„è¯·æ±‚ç»“æœè¦†ç›–ã€‚

è¿™å°±æ˜¯æˆ‘ä»¬è¦è§£å†³çš„ ["race condition"](https://maxrozen.com/race-conditions-fetching-data-react-with-useeffect) ç«æ€é—®é¢˜ã€‚


#### å¸¸è§è§£å†³æ€è·¯

ä¸€ä¸ªç®€å•çš„å¤„ç†ç«æ€é—®é¢˜çš„æ€è·¯ï¼šé€šè¿‡é—­åŒ…çš„ `active` æ ‡è®°æ¥è®©æ—§çš„è¯·æ±‚åœ¨ç»„ä»¶é‡æ¸²æŸ“æ—¶ä¸å†æ‰§è¡Œåç»­é€»è¾‘ã€‚

```tsx
useEffect(() => {
  let active = true

  const fetchData = async () => {
    const response = await fetch(`https://swapi.dev/api/people/${props.id}/`)
    const newData = await response.json()
    if (active) {
      setFetchedId(props.id)
      setData(newData)
    }
  }

  fetchData()

  return () => { active = false }
}, [props.id])
```

- æ¯æ¬¡å‘èµ·è¯·æ±‚éƒ½æœ‰ä¸€ä¸ªæ–°çš„ `active` è¢«åˆ›å»ºï¼Œåªæœ‰å½“ `active` ä¸º `true` æ‰ä¼šæ‰§è¡Œç½‘ç»œè¯·æ±‚çš„åç»­æ“ä½œã€‚

- å½“ç»„ä»¶é‡æ–°æ¸²æŸ“æˆ–è€…è¯´é¡µé¢çŠ¶æ€è¿‡æœŸçš„æ—¶å€™ `active` å˜æˆ `false`ï¼Œè¿™ä¸ª `false` ä½œä¸ºç½‘ç»œè¯·æ±‚çš„é—­åŒ…è¢«ç¼“å­˜åˆ°äº†å›è°ƒå‡½æ•°ä¸­ï¼Œä»è€Œé˜»æ­¢äº†è¿‡æœŸçš„åç»­æ“ä½œã€‚

#### å…¶å®ƒæ–¹å¼

[Reactå®˜æ–¹æ–‡æ¡£](https://zh-hans.react.dev/learn/synchronizing-with-effects#what-are-good-alternatives-to-data-fetching-in-effects) ä¹Ÿåˆ—ä¸¾äº†ä¸€äº›ç›´æ¥åœ¨ `useEffect` ä¸­å‘èµ·ç½‘ç»œè¯·æ±‚çš„ç¼ºç‚¹ä¸æ›¿ä»£æ–¹æ¡ˆã€‚å¹¶æ¨èäº†æˆ‘æƒ³å‘å¤§å®¶ä»‹ç»çš„`react-query`ã€‚



## React Query

### ä»‹ç»

`@tanstack/query` ï¼ˆæ›¾ç”¨å `react-query`ï¼Œä¸‹æ–‡ç®€ç§° queryï¼‰æ˜¯ä¸€ä¸ªå¼‚æ­¥çŠ¶æ€ç®¡ç†å·¥å…·ã€‚

å®ƒæ”¯æŒ reactã€vueã€angular ç­‰ä¸»æµå‰ç«¯æ¡†æ¶ã€‚æˆ‘è‡ªå·±åœ¨å…¬å¸çš„é¡¹ç›®ä¸­æœ‰æ·±åº¦ä½¿ç”¨è¿‡ react å’Œ vue çš„ç‰ˆæœ¬ï¼Œä½“éªŒéƒ½è¿˜ä¸é”™ã€‚

å¼‚æ­¥çŠ¶æ€ç®¡ç†å·¥å…·ï¼Œç®€å•åœ°è¯´ï¼Œå°±æ˜¯ç®¡ç†åŸºäºå¼‚æ­¥æ“ä½œè€Œè·å¾—çš„çŠ¶æ€ã€‚é€šå¸¸æ˜¯ç®¡ç†ç½‘ç»œè¯·æ±‚è¿”å›çš„æ•°æ®ä»¥åŠè¡ç”ŸçŠ¶æ€ã€‚è¿™ä¸ªåç»­ä¼šè¯¦ç»†ä»‹ç»ã€‚

å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªåº“çš„æˆç»©ï¼š[Github](https://github.com/TanStack/query) 42.7k Starï¼Œ NPM [å‘¨ä¸‹è½½é‡](https://www.npmjs.com/package/@tanstack/react-query) 4422006ã€‚

è¿™ä¸ªæ•°æ®çœ‹èµ·æ¥éå¸¸å¤¸å¼ ï¼Œå®é™…ä¸Šä¹Ÿç¡®å®å¦‚æ­¤ï¼Œquery åœ¨å›½å¤–æ˜¯éå¸¸ä¸»æµçš„æŠ€æœ¯é€‰æ‹©ã€‚

## query åŸºç¡€ä½¿ç”¨

è¿™èŠ‚è®²ä¸€ä¸‹ query çš„åŸºç¡€ä½¿ç”¨ï¼Œå‘èµ·ä¸€ä¸ªç½‘ç»œè¯·æ±‚å¾ˆç®€å•ï¼Œåªéœ€è¦è°ƒç”¨ `useQuery`ï¼Œè¯¥å‡½æ•°éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼š `queryKey` å’Œ `queryFn`ã€‚

```tsx
useQuery({
  queryKey: any[],
  queryFn: ()=> Promise
})
```

### å…³äº queryFn

`queryFn` æ€»æ˜¯è¿”å›ä¸€ä¸ª Promiseï¼Œå› ä¸º query å¹¶ä¸åœ¨ä¹ `queryFn` ä¸­æ˜¯å¦æœ‰ä¸€ä¸ªçœŸå®çš„ç½‘ç»œè¯·æ±‚ï¼Œquery åªåœ¨ä¹ Promise çš„çŠ¶æ€ã€‚

å¦‚æœç”¨æµè§ˆå™¨çš„ `fetch` æ¥ç¼–å†™ç½‘ç»œè¯·æ±‚ï¼Œ`queryFn` çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„:

```tsx
queryFn: async () => {
  const response = await fetch(url)
  if (!response.ok) {
    throw new Error(`Error status: ${response.status}`)
  }
  return response.json()
}
```

<Callout type='warn'>
ä¸éœ€è¦åœ¨è¿™é‡ŒåµŒå¥— `try-catch` ï¼Œç›´æ¥ throw Error æ˜¯ä¸ºäº†è®© query çŸ¥é“å‘ç”Ÿäº†é”™è¯¯ã€‚
</Callout>


query çš„å®šä½æ˜¯å¼‚æ­¥çŠ¶æ€ç®¡ç†å·¥å…·ï¼Œå’Œ `pinia`ã€`jotai` è¿™ç§åŒæ­¥çŠ¶æ€ç®¡ç†åº“ã€è¿˜æœ‰ `axios` è¿™ç§ç½‘ç»œè¯·æ±‚åº“æ˜¯å®Œå…¨ä¸å†²çªçš„ï¼Œå› ä¸º__å®šä½ä¸ä¸€æ ·__ã€‚

æ‰€ä»¥æ­£å¼é¡¹ç›®æ¨èæŠŠåŸºäº `axios` å‘èµ·çš„ç½‘ç»œè¯·æ±‚ä½œä¸º `queryFn`ã€‚

### å…³äº queryKey

`queryKey` æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé€šå¸¸é¦–ä½æ˜¯å¯¹çŠ¶æ€çš„ç®€è¦æè¿°ã€‚æ¯”å¦‚å¦‚æœè·å–æ–‡ç« åˆ—è¡¨å°±å¯ä»¥æ˜¯ `['posts']`ã€‚ å¦‚æœè·å–å­¦ç”Ÿè¯¦æƒ…å°±å¯ä»¥æ˜¯`['post', id]`ã€‚

è¯·æ±‚ç›¸å…³çš„å‚æ•°ä¹Ÿåº”è¯¥æ”¾åˆ° `queryKey` åˆ—è¡¨ä¸­ï¼Œæ¯å½“ `queryKey` å˜æ›´å°±ä¼šé‡æ–°æ‰§è¡ŒæŸ¥è¯¢å‡½æ•°ï¼Œå¹¶æŠŠæŸ¥è¯¢ç»“æœç¼“å­˜èµ·æ¥ã€‚

```ts
// id/æ’åº/é¡µç /æ¯é¡µæ¡æ•°/æŸ¥è¯¢å…³é”®å­— ç­‰ç­‰éƒ½åº”è¯¥æ”¾åˆ° query-key ä¸­
useQuery({ queryKey: ['post', id, sort, page, limit, keyword] })
```

å¦‚æœ `queryKey` å‘½ä¸­ç¼“å­˜ä¸­çš„ keyï¼Œquery å°±ä¼šç›´æ¥è¿”å›ä¸Šæ¬¡çš„ç¼“å­˜ç»“æœï¼Œè·³è¿‡äº†é˜»å¡ç”¨æˆ·æ“ä½œçš„`loading`ï¼Œä¹Ÿå°±æå‡äº†ç”¨æˆ·ä½“éªŒã€‚


<Callout type='warn'>
`queryKey` ä¹Ÿè®¸ä¼šè®©äººè”æƒ³åˆ° `useEffect` çš„ä¾èµ–åˆ—è¡¨ï¼Œä½†ä¸å®Œå…¨ç›¸åŒã€‚ã€‚
</Callout>


query ä¼šåŸºäº `queryKey` è®¡ç®— hash å€¼ï¼Œæ‰€ä»¥ä½ å¯ä»¥å¤§èƒ†çš„åœ¨ `queryKey` é‡Œä½¿ç”¨å¯¹è±¡å’Œæ•°ç»„ï¼ŒåŒæ—¶ query ä¼šæ— è§†å¯¹è±¡é”®å€¼å¯¹çš„é¡ºåºã€‚

```ts
useQuery({ queryKey: ['todos', { status, page }], ... })
useQuery({ queryKey: ['todos', { page, status }], ...})
useQuery({ queryKey: ['todos', { page, status, other: undefined }], ... })
```

### ç®€å•ç¤ºä¾‹

ä¸€ä¸ªåŸºç¡€ç¤ºä¾‹ï¼ŒåŸºäºæ‰€é€‰çš„ä¹¦åæŸ¥çœ‹è¯¥ä¹¦çš„è¯¦æƒ…ï¼š

```tsx
import { useState } from 'react'
import { fetchBookDetail } from '../api/book'
import { useQuery } from '@tanstack/react-query'

const books = [
  { id: 1, title: 'React ä»å…¥é—¨åˆ°ç²¾é€š' },
  { id: 2, title: 'æ·±å…¥ç†è§£ Vue' },
  { id: 3, title: 'ä½ ä¸çŸ¥é“çš„ Angular' },
]

export const Intro = () => {
  const [bookId, setBookId] = useState<number>(1)

  const handleChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    setBookId(parseInt(e.target.value))
  }

  const {
    data: book,
    isLoading,
    isError,
    error,
  } = useQuery({
    queryKey: ['book', bookId],
    queryFn: () => fetchBookDetail(bookId),
  })

  if (isLoading) {
    return <p>åŠ è½½ä¸­...</p>
  }

  if (isError) {
    return <p>é”™è¯¯: {error.message}</p>
  }

  return (
    <>
      <select value={bookId} onChange={handleChange}>
        {books.map((book) => (
          <option key={book.id} value={book.id}>
            {book.title}
          </option>
        ))}
      </select>
      <>
        <h1>{book?.title}</h1>
        <p>{book?.author}</p>
        <p>{book?.description}</p>
      </>
    </>
  )
}

```
