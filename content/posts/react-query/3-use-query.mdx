---
title: useQuery å…¶ä»–å‚æ•°ç”¨æ³•è¯¦è§£
description: æœ¬æ–‡ä»‹ç» useQuery å…¶ä»–å‚æ•°ä½¿ç”¨æŠ€å·§ã€‚
date: 2025-05-24
tags: ['react-query', 'å¼‚æ­¥çŠ¶æ€ç®¡ç†']
author: liaoyi
series: react-query
seriesPart: 3
---

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸éœ€è¦æ ¹æ®ä¸åŒåœºæ™¯å¯¹æ¥å£è¯·æ±‚è¿›è¡Œæ›´ç»†è‡´çš„æ§åˆ¶ï¼Œæ¯”å¦‚ï¼šæ˜¯å¦è¯·æ±‚ã€è¯·æ±‚é¡ºåºã€æ˜¯å¦è½®è¯¢ç­‰ã€‚æœ¬æ–‡å°†æ·±å…¥ä»‹ç» useQuery åœ¨è¿™äº›é«˜çº§åœºæ™¯ä¸‹çš„ä½¿ç”¨æ–¹å¼ã€‚

## æ¡ä»¶æ€§è¯·æ±‚ï¼ˆConditional Queriesï¼‰

æœ‰æ—¶æˆ‘ä»¬å¸Œæœ›åªæœ‰åœ¨æ»¡è¶³æŸä¸ªæ¡ä»¶æ—¶æ‰å‘èµ·è¯·æ±‚ï¼Œä¾‹å¦‚æœç´¢å…³é”®è¯å­˜åœ¨æ—¶æ‰è¯·æ±‚æœç´¢ç»“æœã€‚

âš ï¸ é”™è¯¯ç¤ºèŒƒï¼ˆè¿å Hook è§„åˆ™ï¼‰ï¼š

```tsx
if (keyword) {
  useQuery({
    queryKey: ['search', keyword],
    queryFn
  })
}
```

âœ… æ­£ç¡®å†™æ³•ï¼šé€šè¿‡ enabled å‚æ•°æ§åˆ¶è¯·æ±‚æ˜¯å¦å¯ç”¨ã€‚

```tsx
useQuery({
  queryKey: ['search', keyword],
  queryFn,
  enabled: !!keyword // keyword å­˜åœ¨æ—¶æ‰è¯·æ±‚ å³ï¼šä»…å½“ `enabled` ä¸º `true` æ—¶ï¼Œquery æ‰ä¼šè¢«è§¦å‘ã€‚
})
```


## ä¾èµ–æ€§è¯·æ±‚ï¼ˆDependent Queriesï¼‰

æœ‰äº›è¯·æ±‚ä¾èµ–äºå¦ä¸€ä¸ªè¯·æ±‚çš„ç»“æœï¼Œæ¯”å¦‚æ ¹æ®ä¹¦åè·å–ä¹¦ç±ä¿¡æ¯ï¼Œå†æ ¹æ®ä¹¦ç± ID è·å–è¯„è®ºã€‚

âŒ ä¸æ¨èï¼šå°†å¤šä¸ªè¯·æ±‚å†™åœ¨ä¸€ä¸ª queryFn ä¸­ï¼ˆè€¦åˆæ€§é«˜ï¼‰

```tsx
useQuery({
  queryKey: ['book', 'comments', bookTitle],
  queryFn: async () => {
    const book = await fetchBook(bookTitle)
    const comments = await fetchBookComments(book.data.id)
    return { book, comments }
  }
})
```

âœ… æ¨èæ–¹å¼ï¼šæ‹†åˆ†ä¸ºå¤šä¸ª queryï¼Œå¹¶é€šè¿‡ enabled æ§åˆ¶è¯·æ±‚æ—¶æœº

```tsx
const useBookDetail = (bookTitle: string) =>
  useQuery({
    queryKey: ['book', bookTitle],
    queryFn: () => fetchBook(bookTitle),
    enabled: !!bookTitle
  })

const useBookComments = (bookId?: string) =>
  useQuery({
    queryKey: ['comments', bookId],
    queryFn: () => fetchBookComments(bookId!),
    enabled: !!bookId
  })

const useBookDetailAndComments = (bookTitle: string) => {
  const book = useBookDetail(bookTitle)
  const comments = useBookComments(book.data?.id)
  return { book, comments }
}
```

è¿™æ ·ä¸ä»…é™ä½äº†è€¦åˆï¼Œè¿˜èƒ½åˆ†åˆ«ç¼“å­˜å’Œå¤ç”¨æ¯ä¸ªè¯·æ±‚çš„æ•°æ®ã€‚



## è½®è¯¢ï¼ˆPollingï¼‰

å¦‚æœä½ éœ€è¦å®šæ—¶è¯·æ±‚æ•°æ®ï¼Œæ¯”å¦‚æ£€æµ‹æ”¯ä»˜æ˜¯å¦å®Œæˆï¼Œå¯ä»¥ä½¿ç”¨ `refetchInterval` å‚æ•°ã€‚

### 1. ç®€å•è½®è¯¢ï¼š

è½®è¯¢é€šå¸¸ç”¨äºé‚£äº›éœ€è¦å®æ—¶æ€§åé¦ˆçš„åœºæ™¯ï¼Œæ¯”å¦‚æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å®Œæˆæ”¯ä»˜ã€‚

```tsx
useQuery({
  queryKey: ['list', { sort }],
  queryFn,
  refetchInterval: 5000, // æ¯ 5 ç§’è¯·æ±‚ä¸€æ¬¡
});
```

### 2. æ¡ä»¶è½®è¯¢ï¼šä»…åœ¨æŸäº›çŠ¶æ€ä¸‹æŒç»­è½®è¯¢

`refetchInterval` ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚
æƒ³è±¡è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šå‰ç«¯é€šè¿‡è½®è¯¢æ¥å¾—çŸ¥ç”¨æˆ·æ˜¯å¦å®Œæˆæ”¯ä»˜ï¼Œç”¨æˆ·ä¸€æ—¦å®Œæˆæ”¯ä»˜è½®è¯¢å°±è¯¥åœæ­¢ã€‚

```tsx
useQuery({
  //...,
  refetchInterval: (query) => {
    if (query.state.data?.finished) {
      return false; // åœæ­¢è½®è¯¢
    }
    return 3000; // æ¯ 3 ç§’è¯·æ±‚ä¸€æ¬¡
  }
})
```

## ğŸš€ å¹¶å‘è¯·æ±‚ï¼ˆParallel Queriesï¼‰


### 1. Promise.all ç®€å•å®ç°ï¼ˆæ³¨æ„å¤±è´¥ä¼šä¸­æ–­æ‰€æœ‰è¯·æ±‚ï¼‰ï¼š


```tsx
const queryFn = async (bookId: string) => {
  const [book, comments] = await Promise.all([
    fetchBookDetail(bookId),
    fetchBookComments(bookId)
  ])

  return { book, comments }
}

useQuery({
  queryKey: ['bookWithComments', bookId],
  queryFn
})
```

<Callout type='warn' >
å½“ä¸€äº›ä¸šåŠ¡åœºæ™¯éœ€è¦å‰ç«¯å¹¶å‘è‹¥å¹²è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `queryFn` é‡ŒåŸºäº `Promise.all` æ¥å¹¶å‘è¯·æ±‚ã€‚
è¿™å¾ˆå¥½ï¼Œä½†ä¼šè®©ä¸¤ä¸ªè¯·æ±‚è€¦åˆåœ¨ä¸€èµ·ã€‚ä»»æ„è¯·æ±‚çš„å¤±è´¥éƒ½ä¼šå¯¼è‡´æ•´ä¸ªè¯·æ±‚å¤±è´¥ï¼Œä¸”åªæœ‰ä¸€ä¸ªç¼“å­˜ keyï¼Œä¸åˆ©äºç»†ç²’åº¦çš„æ§åˆ¶ç¼“å­˜ã€‚
</Callout>


### 2. ä½¿ç”¨ `useQueries` å¹¶å‘å¤šä¸ªè¯·æ±‚ï¼Œæ”¯æŒæ›´ç»†ç²’åº¦æ§åˆ¶

```tsx
const ids = [1, 2, 3] // // åŸºäº ids å¹¶å‘è¯·æ±‚ï¼Œå¯ä»¥åŠ¨æ€æ§åˆ¶è¯·æ±‚æ•°é‡

const { data, pending } = useQueries({
  queries: ids.map((id) => ({
    queryKey: ['post', id],
    queryFn: () => fetchPost(id),
  })),
  combine: (results) => ({
    data: results.map((r) => r.data),
    pending: results.some((r) => r.isPending)
  })
})

```

<Callout type='warn' >
ä¸Šé¢çš„ä»£ç é€šè¿‡è°ƒç”¨ `useQuery` å¤šæ¬¡ï¼Œè¿™ä¹Ÿå¾ˆå¥½ï¼Œä½†ç¼ºç‚¹æ˜¯ä¸èƒ½åŠ¨æ€æ§åˆ¶è¯·æ±‚å¹¶å‘çš„æ•°é‡ã€‚
</Callout>



### 3. å¤šè¯·æ±‚å¹¶èšåˆç»“æœç¤ºä¾‹ï¼š

å¦‚æœä½ æ˜ç¡®å¹¶å‘çš„è¯·æ±‚ä¹‹é—´å­˜åœ¨é€»è¾‘å…³è”ï¼Œæˆ–è€…éœ€è¦åŠ¨æ€æ§åˆ¶å¹¶å‘æ•°é‡ï¼Œæ›´æ¨èä½¿ç”¨ `useQueries`ã€‚
`useQueries` çš„ `queries` å‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„é‡Œçš„æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ª `useQuery` çš„é…ç½®å¯¹è±¡ã€‚
åŸºäº `combine` å¯ä»¥å®ç°æ›´å¤æ‚çš„èšåˆé€»è¾‘ã€‚


```tsx
const { bookDetail, bookComments, isDetailAndCommentPending } = useQueries({
  queries: [
    {
      queryKey: ['book', selectedBookId],
      queryFn: () => fetchBookDetail(selectedBookId!),
      enabled: !!selectedBookId
    },
    {
      queryKey: ['bookComments', selectedBookId],
      queryFn: () => fetchBookComments(selectedBookId!),
      enabled: !!selectedBookId
    }
  ],
  combine: ([bookDetail, bookComments]) => ({
    bookDetail,
    bookComments,
    isDetailAndCommentPending: bookDetail.isPending || bookComments.isPending
  })
})

```