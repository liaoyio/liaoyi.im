---
title: React Query 预加载
description: 预加载是一种 "提前加载" 数据的策略，通常用于用户即将访问的数据页面，以减少等待时间、提升交互体验。
date: 2025-05-25
tags: ['react-query', '异步状态管理']
author: liaoyi
series: react-query
seriesPart: 4
---


## 为什么要预加载？

以一个典型的书籍列表和详情页为例：

1. 用户访问列表页，加载所有书籍标题。
2. 点击任意书名进入详情页。
3. 详情页再次发起请求，加载书籍详情。
4. 回到列表页时重新发起请求，确保数据最新。
5. 用户再次点击书名，又重新加载详情。

## 存在的问题：

- 每次切换页面都需要等待数据加载。
- 用户快速点击，体验受阻。
- 已访问页面的数据重复请求，浪费资源。


## 优化策略：

1. 如果对数据实时性要求没有特别高的话，请求过的详情页和列表页可以缓存起来，不需要每次都重新请求。
2. 当用户鼠标悬浮在列表项上时，可以预先请求数据，等用户点击列表项时，数据已经请求回来并放到缓存中，这样就减少了用户的等待时间。


## 使用 prefetchQuery 实现预加载

React Query 提供 `queryClient.prefetchQuery()` 方法来执行预加载。

```ts
import { useQueryClient } from "@tanstack/react-query"

const queryClient = useQueryClient();

const handlePrefetch = (id: number) => {
  queryClient.prefetchQuery({
    queryKey: ["book", id],
    queryFn: () => fetchBookDetail(id),
    staleTime: 60 * 1000 // 缓存1分钟，避免频繁请求
  })
}
```

将其绑定到鼠标事件中：

```tsx
<li onMouseEnter={() => handlePrefetch(book.id)}>
  {book.title}
</li>
```

- 通过 `onMouseEnter` 事件来触发预加载
- 通过 `useQueryClient` 来获取 `queryClient.prefetchQuery` 方法来执行预加载。

<Callout type='warn' title="注意" >
记得为 `prefetchQuery` 提供 `staleTime`参数，它表示缓存数据的有效时间，能有效避免过于频繁的网络请求。
</Callout>


## 使用 placeholderData 占位数据

预加载虽好，但并不能保证用户点击前数据一定已返回。如果用户操作特别快，仍可能看到 loading 状态。

如果我们在列表页已加载过部分基础信息，比如书名、分类、出版社信息，那么详情页完全可以先显示这些内容作为 "占位符"。


示例：使用 `getQueryData` 设置占位数据

```tsx
const useBookDetail = (id: number) => {
  const queryClient = useQueryClient()

  return useQuery({
    queryKey: ["book", id],
    queryFn: () => fetchBookDetail(id),
    placeholderData: () => {
      const list = queryClient.getQueryData<{ id: number }[]>(["book"])
      return list?.find((item) => item.id === id)
    }
  })
}
```

`isPlaceholderData` 标识状态:

React Query 会返回 `isPlaceholderData` 标识当前数据是否为占位符，我们可以据此渲染不同 UI：

```ts
{
    isPlaceholderData ?
      <p>loading...</p>
       :
      <p>{data.description}</p>
}
```
