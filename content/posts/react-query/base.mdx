---
title: ä¸€æ–‡æŒæ¡ TanStack Queryï¼šè®© React æ•°æ®ç®¡ç†å˜å¾—ç®€å•é«˜æ•ˆ
description: React Query æ˜¯ç”¨æ¥ç®¡ç†æ¥å£è¯·æ±‚çš„ï¼ŒåŒ…æ‹¬å¢åˆ æ”¹æŸ¥æ‰€æœ‰ç±»å‹çš„æ¥å£ã€‚ç®¡ç†çš„å†…å®¹åŒ…æ‹¬å“åº”æ•°æ®å’Œè¯·æ±‚çŠ¶æ€ï¼Œå¯ä»¥è®©ä½ å°‘äº›å¾ˆå¤šæ ·æ¿ä»£ç ã€‚
date: 2025-06-02
tags: ['react-query', 'å¼‚æ­¥çŠ¶æ€ç®¡ç†']
author: liaoyi
series: react-query
seriesPart: 1
---

## å‰è¨€
åœ¨å¼€å§‹å‰ï¼Œæˆ‘æƒ³è®¨è®ºä¸€ä¸‹**è¯·æ±‚çŠ¶æ€ç®¡ç†çš„å›°å¢ƒ**æ˜¯ä»€ä¹ˆï¼Ÿ

### è¿‡äºç®€æœ´çš„ç½‘ç»œè¯·æ±‚
åœ¨ä½¿ç”¨åŸç”Ÿçš„ `fetch` è¯·æ±‚è·å–æ•°æ®æ—¶ï¼Œå¤§å®¶é€šå¸¸ä¼šè¿™ä¹ˆå†™ï¼š

```jsx
useEffect(() => {
  fetch('https://api.example.com/students')
    .then((res) => res.json())
    .then((data) => {
      setStudents(data)
    })
}, [])
```

ä¸Šé¢çš„ä»£ç è™½ç„¶å¾ˆç®€æ´ï¼Œä½†åªèƒ½åœ¨ demo é‡Œä½¿ç”¨ï¼Œåœ¨çœŸæ­£çš„ç”Ÿäº§ç¯å¢ƒæ— æ³•æ¥å—çš„ï¼Œå› ä¸ºä½ å¯¹è¿™ä¸ªè¯·æ±‚æ²¡æœ‰åšä»»ä½•å¤„ç†ã€‚ä¸€æ—¦è¯·æ±‚æ—¶é—´è¿‡é•¿å´æ²¡æœ‰ä»»ä½•åé¦ˆã€æˆ–è€…è¯·æ±‚å‡ºé”™äº†ä½†å‰ç«¯æ²¡æœ‰ä»»ä½•å“åº”ï¼Œå¯¹ç”¨æˆ·ä½“éªŒæ¥è¯´éƒ½æ˜¯è‡´å‘½æ‰“å‡»ã€‚

### è¿‡äºç¹ççš„çŠ¶æ€å¤„ç†
æ‰€ä»¥åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¼šå†æ·»åŠ  loading å’Œé”™è¯¯å¤„ç†é€»è¾‘ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š


import BadExample from './examples/01-complicated-state-handling.tsx';

 <CodeDisplay component={<BadExample />}>
  <include lang="tsx" >
   ./examples/01-complicated-state-handling.tsx
  </ include>
</CodeDisplay>



+ ä¸ºäº†å¤„ç†æ•°æ®åŠ è½½çŠ¶æ€ï¼Œå†™äº†ä¸€å¤§å † `isLoading` å’Œ `error` çš„åˆ¤æ–­ï¼›
+ ä¸ºäº†å®ç°æ•°æ®ç¼“å­˜ï¼Œä¸å¾—ä¸æ‰‹åŠ¨ç®¡ç† `useState` å’Œ `useEffect`ï¼›
+ å¦‚æœä¸ºäº†å¤„ç†å®æ—¶æ•°æ®æ›´æ–°ï¼Œæˆ‘è¿˜è¦å†™æ›´å¤šæ›´å¤æ‚çš„è½®è¯¢é€»è¾‘...



æˆ‘åªæ˜¯ä¸ºäº†å¤„ç†ä¸€ä¸ªç½‘ç»œè¯·æ±‚çš„è¡ç”Ÿé€»è¾‘ï¼Œä½†ä»£ç å·²ç»å¼€å§‹å˜å¾—å¤æ‚åŒ–ï¼Œæ¨¡æ¿åŒ–äº†ï¼Œè¿™äº›é‡å¤æ€§çš„å·¥ä½œä¸ä»…é™ä½äº†å¼€å‘æ•ˆç‡ï¼Œè¿˜å¢åŠ äº†ä»£ç ç»´æŠ¤çš„éš¾åº¦ï¼

---

ç›´åˆ°æˆ‘é‡åˆ°äº† [TanStack Query](https://tanstack.com/query/latest) ï¼ˆåŸ React Queryï¼‰ï¼Œå®ƒå½»åº•æ”¹å˜äº†æˆ‘çš„å¼€å‘æ–¹å¼ã€‚



## ä¸€ã€ä»€ä¹ˆæ˜¯ TanStack Queryï¼Ÿ
ä¸€ä¸ªå¼ºå¤§çš„å¼‚æ­¥çŠ¶æ€ç®¡ç†å·¥å…·ï¼Œå¯ä»¥è®©ä½ å°‘äº›å¾ˆå¤šæ ·æ¿ä»£ç ï¼ŒåŠŸèƒ½å¦‚ä¸‹ï¼š



+ æ•°æ®è·å–å’Œç¼“å­˜ï¼šè‡ªåŠ¨ç®¡ç†å¼‚æ­¥æ•°æ®çš„è·å–å’Œç¼“å­˜ï¼Œå‡å°‘ä¸å¿…è¦çš„è¯·æ±‚ã€‚
+ å®æ—¶æ•°æ®æ›´æ–°ï¼šæ”¯æŒå®æ—¶æ•°æ®æ›´æ–°ï¼Œé€šè¿‡è½®è¯¢æˆ– WebSocket ç­‰æœºåˆ¶è·å–æœ€æ–°æ•°æ®ã€‚
+ è‡ªåŠ¨é‡æ–°è·å–ï¼šå½“ç½‘ç»œæ¢å¤æˆ–çª—å£é‡æ–°è·å¾—ç„¦ç‚¹æ—¶ï¼Œè‡ªåŠ¨é‡æ–°è·å–æ•°æ®ã€‚
+ åˆ†é¡µå’Œæ— é™åŠ è½½ï¼šæ”¯æŒåˆ†é¡µå’Œæ— é™æ»šåŠ¨ï¼Œç®€åŒ–å¤„ç†å¤§æ•°æ®é›†çš„è¿‡ç¨‹ã€‚
+ è¯·æ±‚é‡è¯•ï¼šåœ¨è¯·æ±‚å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•ï¼Œå¢åŠ è¯·æ±‚çš„æˆåŠŸç‡ã€‚
+ é”™è¯¯å¤„ç†ï¼šæä¾›ç®€å•çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œä¾¿äºæ•è·å’Œå¤„ç†è¯·æ±‚é”™è¯¯ã€‚
+ æŸ¥è¯¢å’Œå˜æ›´çš„åˆ†ç¦»ï¼šæ˜ç¡®åŒºåˆ†æ•°æ®è·å–ï¼ˆæŸ¥è¯¢ï¼‰å’Œæ•°æ®å˜æ›´ï¼ˆå˜æ›´ï¼‰ï¼Œä½¿ä»£ç æ›´æ¸…æ™°ã€‚
+ çµæ´»çš„æŸ¥è¯¢ï¼šæ”¯æŒå¤æ‚çš„æŸ¥è¯¢å‚æ•°ï¼Œå¯ä»¥è½»æ¾ç®¡ç†ä¸åŒçš„æ•°æ®è¯·æ±‚ã€‚
+ DevToolsï¼šæä¾›å¼€å‘è€…å·¥å…·ï¼Œä¾¿äºè°ƒè¯•å’Œç›‘æ§æ•°æ®çŠ¶æ€ã€‚



---

**ä¸ React Query çš„å…³ç³»**

React Query æ˜¯ v4 ä»¥å‰çš„å«æ³•ï¼Œä» v4 èµ·å°±å« [TanStack Query](https://tanstack.com/query/latest)ã€‚ä¹‹æ‰€ä»¥æ”¹åå­—ï¼Œæ˜¯å› ä¸ºè¿™ä¸ªå›¢é˜Ÿè¿™å¥—æ–¹æ¡ˆæ¨å¹¿åˆ°é™¤ React ä¹‹å¤–çš„å…¶ä»–æ¡†æ¶ä¸­å»ã€‚åˆ°ç›®å‰ï¼ˆ2025å¹´5æœˆï¼‰æœ€æ–°çš„ v5 ç‰ˆæœ¬å·²ç»æ”¯æŒ Reactã€Vueã€Angularã€Solidã€Svelte 5 å¤§æ¡†æ¶ã€‚


## äºŒã€å¿«é€Ÿå…¥é—¨
### å®˜æ–¹ç¤ºä¾‹
TanStack Query å®˜æ–¹ä¹Ÿæä¾›äº†ä¸€ä¸ªä½¿ç”¨ react-query è·å– React Query GitHub ç»Ÿè®¡ä¿¡æ¯çš„ç®€å•ç¤ºä¾‹ï¼›å¯ä»¥[åœ¨ StackBlitz ä¸­æ‰“å¼€](https%3A%2F%2Fstackblitz.com%2Fgithub%2FTanStack%2Fquery%2Ftree%2Fmain%2Fexamples%2Freact%2Fsimple), ä»£ç å¦‚ä¸‹ï¼š


import TanStackQueryDemo from './examples/02-tanstack-query.tsx';

 <CodeDisplay component={<TanStackQueryDemo />}>
  <include lang="tsx" meta={{title: "tanstack-query.tsx"}}>
   ./examples/02-tanstack-query.tsx
  </ include>
</CodeDisplay>


åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œç»™æˆ‘ä»¬å±•ç¤ºäº† TanStack Query æœ€æ ¸å¿ƒçš„å‡ ä¸ª APIï¼š

+ `QueryClient` ç”¨äºç®¡ç†å’Œé…ç½®æŸ¥è¯¢çš„è¡Œä¸ºã€‚
+ `QueryClientProvider` æ˜¯ä½¿ç”¨ TanStack Query çš„èµ·ç‚¹ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬å¿…é¡»è¦é€šè¿‡ `QueryClient` åˆ›å»ºä¸€ä¸ªå®ä¾‹å¹¶ä¼ å…¥åˆ° `QueryClientProvider` ä¸­ã€‚
+ `useQuery` è·å–æ•°æ®ï¼Œå½“åŠ è½½æ•°æ®æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `isPending` å±æ€§æ¥åˆ¤æ–­æ˜¯å¦æ•°æ®æ­£åœ¨åŠ è½½ä¸­ï¼Œä»è€Œå»å±•ç¤ºåŠ è½½æ—¶çš„ UIã€‚å…¶ä¸­ï¼Œæˆ‘ä»¬å‘ `useQuery` ä¸­ä¼ å…¥äº† `queryKey` å’Œ `queryFn`ï¼Œ`queryKey` ç”¨æ¥ä½œä¸ºè¯¥æŸ¥è¯¢çš„æ ‡è¯†ï¼Œè€Œ `queryFn` å¯¹åº”ä¸ºè·å–æ•°æ®çš„å‡½æ•°ã€‚


## ä¸‰ã€åŸºæœ¬ç”¨æ³•

åœ¨ TanStack Query ä¸­ï¼Œåˆ›å»ºæŸ¥è¯¢éå¸¸ç®€å•ã€‚æˆ‘ä»¬ä½¿ç”¨ `useQuery` é’©å­æ¥å‘èµ·æ•°æ®è¯·æ±‚ã€‚è¿™ä¸ªé’©å­æ¥å—ä¸€ä¸ªé…ç½®å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«æŸ¥è¯¢é”®ï¼ˆqueryKeyï¼‰å’ŒæŸ¥è¯¢å‡½æ•°ï¼ˆqueryFnï¼‰ã€‚


```jsx
const { data, isLoading, error } = useQuery({
    queryKey: any[],
    queryFn: ()=> Promise<any>,
})
```

ä¸»è¦å‚æ•°è¯´æ˜ï¼š

+ `queryKey`ï¼šæŸ¥è¯¢çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºç¼“å­˜ç®¡ç†
+ `queryFn`ï¼šå®é™…è·å–æ•°æ®çš„å¼‚æ­¥å‡½æ•° (å¿…é¡»è¿”å›ä¸€ä¸ª Promise)
+ `enabled`ï¼šæ§åˆ¶æŸ¥è¯¢æ˜¯å¦è‡ªåŠ¨æ‰§è¡Œ
+ `staleTime`ï¼šæ•°æ®ä¿æŒæ–°é²œçš„æ—¶é—´
+ `cacheTime`ï¼šæ•°æ®åœ¨ç¼“å­˜ä¸­ä¿ç•™çš„æ—¶é—´

#### å…³äº queryFn

`queryFn` æ€»æ˜¯è¿”å›ä¸€ä¸ª Promiseï¼Œå› ä¸º query å¹¶ä¸åœ¨ä¹ `queryFn` ä¸­æ˜¯å¦æœ‰ä¸€ä¸ªçœŸå®çš„ç½‘ç»œè¯·æ±‚ï¼Œquery åªåœ¨ä¹ Promise çš„çŠ¶æ€ã€‚

å¦‚æœç”¨æµè§ˆå™¨çš„ `fetch` æ¥ç¼–å†™ç½‘ç»œè¯·æ±‚ï¼Œ`queryFn` çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„:

```tsx
queryFn: async () => {
  const response = await fetch(url)
  if (!response.ok) {
    throw new Error(`Error status: ${response.status}`)
  }
  return response.json()
}
```

<Callout type='warn'>
ä¸éœ€è¦åœ¨è¿™é‡ŒåµŒå¥— `try-catch` ï¼Œç›´æ¥ throw Error æ˜¯ä¸ºäº†è®© query çŸ¥é“å‘ç”Ÿäº†é”™è¯¯ã€‚
</Callout>

#### å…³äº queryKey

```ts
// id/æ’åº/é¡µç /æ¯é¡µæ¡æ•°/æŸ¥è¯¢å…³é”®å­— ç­‰ç­‰éƒ½åº”è¯¥æ”¾åˆ° query-key ä¸­
useQuery({ queryKey: ['post', id, sort, page, limit, keyword] })

useQuery({ queryKey: ['todos', { status, page }], ... })
useQuery({ queryKey: [{ status, page }, 'todos'], ...})
```

- `queryKey` æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé€šå¸¸é¦–ä½æ˜¯å¯¹çŠ¶æ€çš„ç®€è¦æè¿°ã€‚
- è¯·æ±‚ç›¸å…³çš„å‚æ•°éƒ½åº”è¯¥æ”¾åˆ° `queryKey` æ•°ç»„ä¸­ï¼Œæ¯å½“ `queryKey` å˜æ›´å°±ä¼šé‡æ–°æ‰§è¡ŒæŸ¥è¯¢å‡½æ•°ã€‚
- å¦‚æœ `queryKey` å‘½ä¸­ç¼“å­˜ä¸­çš„ keyï¼Œä¼šç›´æ¥è¿”å›ä¸Šæ¬¡çš„ç¼“å­˜ç»“æœï¼Œè·³è¿‡äº†é˜»å¡ç”¨æˆ·æ“ä½œçš„ `loading`ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚
- `queryKey` ä¹Ÿè®¸ä¼šè®©äººè”æƒ³åˆ° `useEffect` çš„ä¾èµ–åˆ—è¡¨ï¼Œä½†ä¸å®Œå…¨ç›¸åŒï¼Œ useQuery ä¼šåŸºäº `queryKey` è®¡ç®— hash å€¼ï¼Œæ‰€ä»¥ä½ å¯ä»¥å¤§èƒ†çš„åœ¨ `queryKey` é‡Œä½¿ç”¨å¯¹è±¡å’Œæ•°ç»„ï¼Œæ— è§†å¯¹è±¡é”®å€¼å¯¹çš„é¡ºåºã€‚



#### ç®€å•ç¤ºä¾‹
è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªå®é™…çš„ä¾‹å­ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ `useQuery` è·å–ç”¨æˆ·æ•°æ®ï¼š

import QueryUserExample from './examples/01-use-query-user.tsx';

 <CodeDisplay component={<QueryUserExample />}>
  <include lang="tsx" >
   ./examples/01-use-query-user.tsx
  </ include>
</CodeDisplay>


### åˆ›å»ºå˜æ›´è¯·æ±‚
é™¤äº†æŸ¥è¯¢æ•°æ®ï¼Œæˆ‘ä»¬ç»å¸¸è¿˜éœ€è¦åˆ›å»ºã€ä¿®æ”¹ã€æ›´æ–°ã€åˆ é™¤æ•°æ®æˆ–æ‰§è¡ŒæœåŠ¡å™¨ç«¯å‰¯ä½œç”¨ã€‚ä¸ºæ­¤ï¼ŒTanStack Query æä¾›äº† useMutation é’©å­æ¥å¤„ç†è¿™äº›æ•°æ®å˜æ›´æ“ä½œã€‚


#### ä»€ä¹ˆæ˜¯ Mutation?

æ‰€æœ‰çŠ¶æ€ç®¡ç†å·¥å…·æœ¬è´¨ä¸Šéƒ½æ˜¯åœ¨åšä¸¤ä»¶äº‹: ä¸€ä¸ªæ˜¯ `è·å–æ•°æ®`ï¼Œä¸€ä¸ªæ˜¯ `ä¿®æ”¹æ•°æ®`ã€‚
æ¯”å¦‚ React ä¸­çš„ `useState` hookï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒæœ¬è´¨ä¹Ÿæ˜¯ä¸€ç§çŠ¶æ€ç®¡ç†ã€‚

```ts
const [state, setState] = useState(initialState)
```
å…¶ä¸­ `state` æ˜¯è·å–æ•°æ®ï¼Œ`setState` ç”¨äºä¿®æ”¹æ•°æ®ã€‚

åœ¨ TanStack Query ä¸­ï¼Œæ•°æ®è·å–ç”± useQuery è´Ÿè´£ï¼Œè€Œæ•°æ®ä¿®æ”¹åˆ™ç”± useMutation å¤„ç†ã€‚
> æˆ‘ä¸ªäººç†è§£ï¼Œå°±æ˜¯ä¸º `POST`/`PUT`/`DELETE` ç­‰è¯·æ±‚æä¾›äº†ä¸€ä¸ªæ›´æ–¹ä¾¿çš„é’©å­ã€‚


#### ä½¿ç”¨ useMutation é’©å­
`useMutation` é’©å­çš„åŸºæœ¬ç»“æ„å¦‚ä¸‹ï¼š

```jsx
const { mutate, isPending, isSuccess, isError } = useMutation({
  mutationFn: () => {
    return axios.post("/api/user", { name: "jack" })
  },
  onMutate: () => {
    console.log("å¼€å§‹å˜æ›´")
  },
  onSuccess: () => {
    console.log("å˜æ›´æˆåŠŸ")
  },
  onError: () => {
    console.log("å˜æ›´å¤±è´¥")
  },
  onSettled: () => {
    console.log("å˜æ›´å®Œæˆï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰")
  }
})
```

ä¸»è¦å‚æ•°è¯´æ˜ï¼š

+ `mutationFn`ï¼šæ‰§è¡Œæ•°æ®å˜æ›´çš„å‡½æ•°
+ `onSuccess`ï¼šå˜æ›´æˆåŠŸåçš„å›è°ƒ
+ `onError`ï¼šå‘ç”Ÿé”™è¯¯æ—¶çš„å›è°ƒ
+ `onSettled`ï¼šæ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¼šæ‰§è¡Œçš„å›è°ƒ


ä¸ºä»€ä¹ˆä¸ç”¨ `axios.post()` è€Œä½¿ç”¨ `useMutation` ?

å› ä¸º`useMutation` å¯ä»¥è®©æˆ‘ä»¬æ›´æ–¹ä¾¿è·å–çŠ¶æ€å’Œæ‹“å±•åŠŸèƒ½ï¼š

1. å†…å»ºçŠ¶æ€ï¼šå¦‚ `isPending`ã€`isSuccess`ã€`isError`ï¼›
2. è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼šæ”¯æŒé…ç½® `retry`ï¼›
3. ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼šå¯ä»¥å¤„ç† UI æç¤ºã€ç¼“å­˜æ›´æ–°ç­‰é€»è¾‘ï¼›
4. å’Œ `QueryClient` ç´§å¯†é›†æˆï¼Œå¯ç›´æ¥æ“ä½œç¼“å­˜ã€‚

<Callout type='warn' >
- å¦‚æœ `mutationFn` ä¸­è¿”å›çš„ Promise ä¸º`reject` çŠ¶æ€ï¼Œé‚£ä¹ˆå°±ç®—æ¥å£è¯·æ±‚æˆåŠŸäº†ï¼Œ`onSuccess` ä¹Ÿä¸ä¼šè§¦å‘ã€‚
- useMutation çš„ throwOnError å‚æ•°å¯ä»¥æ§åˆ¶æ˜¯å¦æŠ›å‡ºé”™è¯¯ï¼Œä½†é»˜è®¤æ˜¯`false`
- æ¢å¥è¯è¯´ï¼Œå¦‚æœ `onSuccess` ä¸€ç›´ä¸è§¦å‘ï¼Œè¯·å°† throwOnError è®¾ä¸º trueï¼ŒæŸ¥çœ‹æ˜¯å¦æŠ¥é”™ã€‚
</Callout>


ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ `useMutation` åˆ›å»ºæ–°ç”¨æˆ·çš„ä¾‹å­ï¼š

import UseMutationExample from './examples/04-use-mutation.tsx';

 <CodeDisplay component={<UseMutationExample />}>
  <include lang="tsx" >
   ./examples/04-use-mutation.tsx
  </ include>
</CodeDisplay>

è¿™ä¸ªä¾‹å­å±•ç¤ºä¸­ï¼š

1. ä½¿ç”¨ `useMutation` åˆ›å»ºæ•°æ®å˜æ›´æ“ä½œ
2. å¤„ç†æˆåŠŸå’Œé”™è¯¯æƒ…å†µ
3. åœ¨æˆåŠŸåæ›´æ–°ç¼“å­˜
4. åœ¨è¡¨å•æäº¤æ—¶è§¦å‘å˜æ›´
5. æ˜¾ç¤ºåŠ è½½çŠ¶æ€

é€šè¿‡è¿™äº›åŸºæœ¬ç”¨æ³•ï¼Œä½ å¯ä»¥å¼€å§‹ä½¿ç”¨ TanStack Query æ¥å¤„ç†å¤§å¤šæ•°æ•°æ®è·å–å’Œå˜æ›´çš„åœºæ™¯ã€‚

## å››ã€æŸ¥è¯¢çŠ¶æ€ç®¡ç†
åœ¨ TanStack Query ä¸­ï¼Œæ¯ä¸ªæŸ¥è¯¢éƒ½æœ‰å…¶çŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°ç®¡ç†æ•°æ®åŠ è½½ã€é”™è¯¯å¤„ç†å’Œç”¨æˆ·ä½“éªŒã€‚è®©æˆ‘ä»¬æ·±å…¥äº†è§£è¿™äº›çŠ¶æ€åŠå…¶ä½¿ç”¨æ–¹æ³•ã€‚

### æŸ¥è¯¢çŠ¶æ€
TanStack Query æä¾›äº†å¤šä¸ªçŠ¶æ€æ ‡å¿—æ¥å¸®åŠ©æˆ‘ä»¬äº†è§£æŸ¥è¯¢çš„å½“å‰çŠ¶æ€ï¼š

```jsx
const {
    // è¿”å›çš„æ•°æ®
    data,           // é»˜è®¤ä¸º undefinedï¼ŒæŸ¥è¯¢æœ€åä¸€æ¬¡æˆåŠŸè§£æçš„æ•°æ®
    dataUpdatedAt,  // æŸ¥è¯¢æœ€è¿‘ä¸€æ¬¡è¿”å› "success" çŠ¶æ€çš„æ—¶é—´æˆ³
    error,          // é»˜è®¤ä¸º nullï¼ŒæŸ¥è¯¢æŠ›å‡ºçš„é”™è¯¯å¯¹è±¡
    errorUpdatedAt, // æŸ¥è¯¢æœ€è¿‘ä¸€æ¬¡è¿”å› "error" çŠ¶æ€çš„æ—¶é—´æˆ³
    failureCount,   // æŸ¥è¯¢å¤±è´¥çš„æ¬¡æ•°ï¼Œæ¯æ¬¡å¤±è´¥é€’å¢ï¼ŒæˆåŠŸæ—¶é‡ç½®ä¸º 0
    failureReason,  // æŸ¥è¯¢é‡è¯•çš„å¤±è´¥åŸå› ï¼ŒæˆåŠŸæ—¶é‡ç½®ä¸º null
    fetchStatus,    // è·å–çŠ¶æ€ï¼š'fetching'(æ­£åœ¨æ‰§è¡Œ) | 'paused'(å·²æš‚åœ) | 'idle'(ç©ºé—²)
    isError,        // ä» status æ´¾ç”Ÿçš„å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦å‘ç”Ÿé”™è¯¯
    isFetched,      // æŸ¥è¯¢æ˜¯å¦å·²è¢«è·å–è¿‡
    isFetchedAfterMount, // æŸ¥è¯¢æ˜¯å¦åœ¨ç»„ä»¶æŒ‚è½½åè¢«è·å–è¿‡ï¼Œå¯ç”¨äºä¸æ˜¾ç¤ºä»»ä½•ç¼“å­˜çš„æ—§æ•°æ®
    isFetching,     // ä» fetchStatus æ´¾ç”Ÿçš„å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦æ­£åœ¨è·å–æ•°æ®
    isInitialLoading, // å·²åºŸå¼ƒï¼Œå°†åœ¨ä¸‹ä¸€ä¸ªå¤§ç‰ˆæœ¬ä¸­ç§»é™¤ï¼Œæ˜¯ isLoading çš„åˆ«å
    isLoading,      // æŸ¥è¯¢é¦–æ¬¡è·å–æ˜¯å¦æ­£åœ¨è¿›è¡Œä¸­ï¼Œç­‰åŒäº isFetching && isPending
    isLoadingError, // æŸ¥è¯¢é¦–æ¬¡è·å–æ—¶æ˜¯å¦å¤±è´¥
    isPaused,       // ä» fetchStatus æ´¾ç”Ÿçš„å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæŸ¥è¯¢æ˜¯å¦è¢«æš‚åœ
    isPending,      // ä» status æ´¾ç”Ÿçš„å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦å¤„äº pending çŠ¶æ€
    isPlaceholderData, // æ˜¾ç¤ºçš„æ•°æ®æ˜¯å¦ä¸ºå ä½æ•°æ®
    isRefetchError, // æŸ¥è¯¢é‡æ–°è·å–æ—¶æ˜¯å¦å¤±è´¥
    isRefetching,   // åå°é‡æ–°è·å–æ˜¯å¦æ­£åœ¨è¿›è¡Œä¸­ï¼Œç­‰åŒäº isFetching && !isPending
    isStale,        // ç¼“å­˜ä¸­çš„æ•°æ®æ˜¯å¦å·²å¤±æ•ˆæˆ–è¶…è¿‡ staleTime
    isSuccess,      // ä» status æ´¾ç”Ÿçš„å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦æˆåŠŸè·å–æ•°æ®
    promise,        // ä¸€ä¸ªç¨³å®šçš„ Promiseï¼Œå°†è§£æä¸ºæŸ¥è¯¢çš„æ•°æ®ï¼ˆéœ€è¦å¯ç”¨ experimental_prefetchInRender ç‰¹æ€§ï¼‰
    refetch,        // æ‰‹åŠ¨é‡æ–°è·å–æŸ¥è¯¢çš„å‡½æ•°ï¼Œå¯é…ç½® throwOnError å’Œ cancelRefetch é€‰é¡¹
    status,         // æŸ¥è¯¢çŠ¶æ€ï¼š'pending'(æ— ç¼“å­˜æ•°æ®ä¸”æŸ¥è¯¢æœªå®Œæˆ) | 'error'(æŸ¥è¯¢å‡ºé”™) | 'success'(æŸ¥è¯¢æˆåŠŸ)
} = useQuery(
    {
        queryKey,     // æŸ¥è¯¢çš„å”¯ä¸€é”®ï¼Œç”¨äºç¼“å­˜å’Œé‡æ–°è·å–
        queryFn,      // ç”¨äºè¯·æ±‚æ•°æ®çš„å‡½æ•°
        gcTime,       // æœªä½¿ç”¨/éæ´»åŠ¨ç¼“å­˜æ•°æ®åœ¨å†…å­˜ä¸­ä¿ç•™çš„æ—¶é—´ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰
        enabled,      // æ˜¯å¦è‡ªåŠ¨æ‰§è¡ŒæŸ¥è¯¢
        networkMode,  // ç½‘ç»œæ¨¡å¼ï¼š'online' | 'always' | 'offlineFirst'
        initialData,  // åˆå§‹æ•°æ®ï¼Œåœ¨æŸ¥è¯¢åˆ›å»ºæˆ–ç¼“å­˜å‰ä½¿ç”¨ï¼Œé»˜è®¤è¢«è§†ä¸ºè¿‡æœŸæ•°æ®
        initialDataUpdatedAt, // åˆå§‹æ•°æ®æœ€åæ›´æ–°çš„æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
        meta,         // å¯å­˜å‚¨æŸ¥è¯¢ç›¸å…³çš„é¢å¤–ä¿¡æ¯ï¼Œå¯åœ¨æŸ¥è¯¢å¯ç”¨å¤„è®¿é—®
        notifyOnChangeProps, // æŒ‡å®šå“ªäº›å±æ€§å˜åŒ–æ—¶è§¦å‘é‡æ–°æ¸²æŸ“
        placeholderData, // æŸ¥è¯¢å¤„äº pending çŠ¶æ€æ—¶ä½¿ç”¨çš„å ä½æ•°æ®ï¼Œä¸ä¼šæŒä¹…åŒ–åˆ°ç¼“å­˜
        queryKeyHashFn, // è‡ªå®šä¹‰æŸ¥è¯¢é”®çš„å“ˆå¸Œå‡½æ•°
        refetchInterval, // è‡ªåŠ¨é‡æ–°è·å–çš„æ—¶é—´é—´éš”ï¼ˆæ¯«ç§’ï¼‰
        refetchIntervalInBackground, // åœ¨åå°æ—¶æ˜¯å¦ç»§ç»­è‡ªåŠ¨é‡æ–°è·å–
        refetchOnMount, // ç»„ä»¶æŒ‚è½½æ—¶æ˜¯å¦é‡æ–°è·å–
        refetchOnReconnect, // ç½‘ç»œé‡è¿æ—¶æ˜¯å¦é‡æ–°è·å–
        refetchOnWindowFocus, // çª—å£è·å¾—ç„¦ç‚¹æ—¶æ˜¯å¦é‡æ–°è·å–
        retry,        // å¤±è´¥é‡è¯•æ¬¡æ•°
        retryOnMount, // ç»„ä»¶æŒ‚è½½æ—¶æ˜¯å¦é‡è¯•å¤±è´¥çš„æŸ¥è¯¢
        retryDelay,   // é‡è¯•å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        select,       // æ•°æ®è½¬æ¢å‡½æ•°ï¼Œç”¨äºåœ¨è¿”å›æ•°æ®å‰è½¬æ¢æ•°æ®
        staleTime,    // æ•°æ®ä¿æŒæ–°é²œçš„æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        structuralSharing, // æ˜¯å¦å¯ç”¨ç»“æ„å…±äº«ï¼Œé»˜è®¤ä¸º true
        subscribed,   // æ˜¯å¦è®¢é˜…ç¼“å­˜æ›´æ–°ï¼Œé»˜è®¤ä¸º true
        throwOnError, // æ˜¯å¦åœ¨æ¸²æŸ“é˜¶æ®µæŠ›å‡ºé”™è¯¯å¹¶ä¼ æ’­åˆ°æœ€è¿‘çš„é”™è¯¯è¾¹ç•Œ
    },
    queryClient,     // è‡ªå®šä¹‰ QueryClient å®ä¾‹ï¼Œå¦åˆ™ä½¿ç”¨æœ€è¿‘ä¸Šä¸‹æ–‡ä¸­çš„å®ä¾‹
)

```

ä¸Šé¢è¿™æ®µä»£ç å°±æ˜¯ useQuery çš„åŸºæœ¬ç»“æ„ï¼Œä¹Ÿæ ‡æ³¨äº†è¯¦ç»†çš„æ³¨é‡Šï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ï¼


### çŠ¶æ€æ›´æ–°å’Œç¼“å­˜

TanStack Query æä¾›äº†å¤šç§æ–¹å¼æ¥ç®¡ç†æŸ¥è¯¢çŠ¶æ€å’Œç¼“å­˜ï¼š

```jsx
const queryClient = useQueryClient();

// æ‰‹åŠ¨æ›´æ–°ç¼“å­˜
queryClient.setQueryData(['todos'], (oldData) => {
    return oldData.map(todo =>
        todo.id === updatedTodo.id ? updatedTodo : todo
    )
})

// ä½¿æŸ¥è¯¢å¤±æ•ˆå¹¶é‡æ–°è·å–
queryClient.invalidateQueries({ queryKey: ['todos'] })

// é¢„å–æ•°æ®
queryClient.prefetchQuery({
    queryKey: ['todos'],
    queryFn: fetchTodos,
})

```

### çŠ¶æ€åŒæ­¥
å½“å¤šä¸ªç»„ä»¶ä½¿ç”¨ç›¸åŒçš„æŸ¥è¯¢æ—¶ï¼Œå®ƒä»¬ä¼šè‡ªåŠ¨å…±äº«çŠ¶æ€ï¼š

```jsx
// ComponentA.tsx
function ComponentA() {
    const { data } = useQuery({
        queryKey: ['todos'],
        queryFn: fetchTodos,
    })
}

// ComponentB.tsx
function ComponentB() {
    const { data } = useQuery({
        queryKey: ['todos'],
        queryFn: fetchTodos,
    });
    // è‡ªåŠ¨å…±äº« ComponentA çš„æ•°æ®å’ŒçŠ¶æ€ï¼Œå¦‚æœä¸æƒ³ä½¿ç”¨ ComponentA å…±äº«çš„æ•°æ®å’ŒçŠ¶æ€ï¼Œå¯ä»¥ç»§ç»­æ·»åŠ  queryKey
}

```

é€šè¿‡åˆç†ä½¿ç”¨è¿™äº›çŠ¶æ€ç®¡ç†ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºå‡ºæ›´åŠ å¥å£®å’Œç”¨æˆ·å‹å¥½çš„åº”ç”¨ç¨‹åº


## ğŸ§šâ€â™€ï¸ æ•°æ®é¢„åŠ è½½

> é¢„åŠ è½½æ˜¯ä¸€ç§ "æå‰åŠ è½½" æ•°æ®çš„ç­–ç•¥ï¼Œé€šå¸¸ç”¨äºç”¨æˆ·å³å°†è®¿é—®çš„æ•°æ®é¡µé¢ï¼Œä»¥å‡å°‘ç­‰å¾…æ—¶é—´ã€æå‡äº¤äº’ä½“éªŒã€‚


### ä¸ºä»€ä¹ˆè¦é¢„åŠ è½½ï¼Ÿ

ä»¥ä¸€ä¸ªå…¸å‹çš„ä¹¦ç±åˆ—è¡¨å’Œè¯¦æƒ…é¡µä¸ºä¾‹ï¼š

1. ç”¨æˆ·è®¿é—®åˆ—è¡¨é¡µï¼ŒåŠ è½½æ‰€æœ‰ä¹¦ç±æ ‡é¢˜ã€‚
2. ç‚¹å‡»ä»»æ„ä¹¦åè¿›å…¥è¯¦æƒ…é¡µã€‚
3. è¯¦æƒ…é¡µå†æ¬¡å‘èµ·è¯·æ±‚ï¼ŒåŠ è½½ä¹¦ç±è¯¦æƒ…ã€‚
4. å›åˆ°åˆ—è¡¨é¡µæ—¶é‡æ–°å‘èµ·è¯·æ±‚ï¼Œç¡®ä¿æ•°æ®æœ€æ–°ã€‚
5. ç”¨æˆ·å†æ¬¡ç‚¹å‡»ä¹¦åï¼Œåˆé‡æ–°åŠ è½½è¯¦æƒ…ã€‚

### å­˜åœ¨çš„é—®é¢˜ï¼š

- æ¯æ¬¡åˆ‡æ¢é¡µé¢éƒ½éœ€è¦ç­‰å¾…æ•°æ®åŠ è½½ã€‚
- ç”¨æˆ·å¿«é€Ÿç‚¹å‡»ï¼Œä½“éªŒå—é˜»ã€‚
- å·²è®¿é—®é¡µé¢çš„æ•°æ®é‡å¤è¯·æ±‚ï¼Œæµªè´¹èµ„æºã€‚


### ä¼˜åŒ–ç­–ç•¥ï¼š

1. å¦‚æœå¯¹æ•°æ®å®æ—¶æ€§è¦æ±‚æ²¡æœ‰ç‰¹åˆ«é«˜çš„è¯ï¼Œè¯·æ±‚è¿‡çš„è¯¦æƒ…é¡µå’Œåˆ—è¡¨é¡µå¯ä»¥ç¼“å­˜èµ·æ¥ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½é‡æ–°è¯·æ±‚ã€‚
2. å½“ç”¨æˆ·é¼ æ ‡æ‚¬æµ®åœ¨åˆ—è¡¨é¡¹ä¸Šæ—¶ï¼Œå¯ä»¥é¢„å…ˆè¯·æ±‚æ•°æ®ï¼Œç­‰ç”¨æˆ·ç‚¹å‡»åˆ—è¡¨é¡¹æ—¶ï¼Œæ•°æ®å·²ç»è¯·æ±‚å›æ¥å¹¶æ”¾åˆ°ç¼“å­˜ä¸­ï¼Œè¿™æ ·å°±å‡å°‘äº†ç”¨æˆ·çš„ç­‰å¾…æ—¶é—´ã€‚


#### ä½¿ç”¨ prefetchQuery å®ç°é¢„åŠ è½½

React Query æä¾› `queryClient.prefetchQuery()` æ–¹æ³•æ¥æ‰§è¡Œé¢„åŠ è½½ã€‚

```ts
import { useQueryClient } from "@tanstack/react-query"

const queryClient = useQueryClient();

const handlePrefetch = (id: number) => {
  queryClient.prefetchQuery({
    queryKey: ["book", id],
    queryFn: () => fetchBookDetail(id),
    staleTime: 60 * 1000 // ç¼“å­˜1åˆ†é’Ÿï¼Œé¿å…é¢‘ç¹è¯·æ±‚
  })
}
```

å°†å…¶ç»‘å®šåˆ°é¼ æ ‡äº‹ä»¶ä¸­ï¼š

```tsx
<li onMouseEnter={() => handlePrefetch(book.id)}>
  {book.title}
</li>
```

- é€šè¿‡ `onMouseEnter` äº‹ä»¶æ¥è§¦å‘é¢„åŠ è½½
- é€šè¿‡ `useQueryClient` æ¥è·å– `queryClient.prefetchQuery` æ–¹æ³•æ¥æ‰§è¡Œé¢„åŠ è½½ã€‚

<Callout type='warn' title="æ³¨æ„" >
è®°å¾—ä¸º `prefetchQuery` æä¾› `staleTime`å‚æ•°ï¼Œå®ƒè¡¨ç¤ºç¼“å­˜æ•°æ®çš„æœ‰æ•ˆæ—¶é—´ï¼Œèƒ½æœ‰æ•ˆé¿å…è¿‡äºé¢‘ç¹çš„ç½‘ç»œè¯·æ±‚ã€‚
</Callout>


#### ä½¿ç”¨ placeholderData å ä½æ•°æ®

é¢„åŠ è½½è™½å¥½ï¼Œä½†å¹¶ä¸èƒ½ä¿è¯ç”¨æˆ·ç‚¹å‡»å‰æ•°æ®ä¸€å®šå·²è¿”å›ã€‚å¦‚æœç”¨æˆ·æ“ä½œç‰¹åˆ«å¿«ï¼Œä»å¯èƒ½çœ‹åˆ° loading çŠ¶æ€ã€‚

å¦‚æœæˆ‘ä»¬åœ¨åˆ—è¡¨é¡µå·²åŠ è½½è¿‡éƒ¨åˆ†åŸºç¡€ä¿¡æ¯ï¼Œæ¯”å¦‚ä¹¦åã€åˆ†ç±»ã€å‡ºç‰ˆç¤¾ä¿¡æ¯ï¼Œé‚£ä¹ˆè¯¦æƒ…é¡µå®Œå…¨å¯ä»¥å…ˆæ˜¾ç¤ºè¿™äº›å†…å®¹ä½œä¸º "å ä½ç¬¦"ã€‚


ç¤ºä¾‹ï¼šä½¿ç”¨ `getQueryData` è®¾ç½®å ä½æ•°æ®

```tsx
const useBookDetail = (id: number) => {
  const queryClient = useQueryClient()

  return useQuery({
    queryKey: ["book", id],
    queryFn: () => fetchBookDetail(id),
    placeholderData: () => {
      const list = queryClient.getQueryData<{ id: number }[]>(["book"])
      return list?.find((item) => item.id === id)
    }
  })
}
```

`isPlaceholderData` æ ‡è¯†çŠ¶æ€:

React Query ä¼šè¿”å› `isPlaceholderData` æ ‡è¯†å½“å‰æ•°æ®æ˜¯å¦ä¸ºå ä½ç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥æ®æ­¤æ¸²æŸ“ä¸åŒ UIï¼š

```ts
{
    isPlaceholderData ?
      <p>loading...</p>
       :
      <p>{data.description}</p>
}
```


## äº”ã€æ•°æ®ç¼“å­˜ä¸æ›´æ–°

TanStack Query çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€æ˜¯å…¶å¼ºå¤§çš„ç¼“å­˜æœºåˆ¶ã€‚å®ƒä¸ä»…èƒ½è‡ªåŠ¨ç®¡ç†ç¼“å­˜ï¼Œè¿˜æä¾›äº†å¤šç§æ–¹å¼æ¥æ‰‹åŠ¨æ§åˆ¶ç¼“å­˜æ•°æ®ã€‚

### ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜ï¼Ÿ

åœ¨å®é™…ä¸šåŠ¡å¼€å‘ä¸­ï¼Œé¢‘ç¹çš„ç½‘ç»œè¯·æ±‚ä¸ä»…ä¼šå¢åŠ æœåŠ¡å™¨è´Ÿæ‹…ï¼Œè¿˜ä¼šå½±å“ç”¨æˆ·ä½“éªŒã€‚è€Œå¾ˆå¤šåœºæ™¯ä¸‹çš„æ•°æ®å…¶å®å¹¶ä¸éœ€è¦å®æ—¶æ›´æ–°ï¼Œæˆ‘ä»¬å¯ä»¥åˆç†è®¾ç½®ç¼“å­˜æ—¶é—´æ¥é™ä½è¯·æ±‚é¢‘ç‡ã€‚

å¸¸è§çš„ä¾‹å­åŒ…æ‹¬ï¼š

- ğŸ“ˆ åŸºé‡‘æ”¶ç›Šæ˜ç»†ï¼šé€šå¸¸æ¯å¤©åªæ›´æ–°ä¸€æ¬¡ï¼›
- ğŸ‘¨ğŸ»â€ğŸ’» ç”¨æˆ·å¤´åƒï¼šåªæœ‰ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹æ—¶æ‰ä¼šå˜åŒ–ï¼›
- ğŸ’¬ è¯„è®ºåˆ—è¡¨ï¼šå¦‚æœå¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜ï¼ŒåŠå°æ—¶æ›´æ–°ä¸€æ¬¡ä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ã€‚


### ç¼“å­˜æœºåˆ¶
TanStack Query ä½¿ç”¨æŸ¥è¯¢é”®ï¼ˆQuery Keyï¼‰æ¥æ ‡è¯†å’Œå­˜å‚¨ç¼“å­˜æ•°æ®ã€‚**å½“ä½¿ç”¨ç›¸åŒçš„æŸ¥è¯¢é”®æ—¶ï¼Œæ•°æ®ä¼šè¢«è‡ªåŠ¨ç¼“å­˜å’Œå…±äº«**ã€‚

```jsx
// ä½¿ç”¨ç›¸åŒçš„æŸ¥è¯¢é”®ï¼Œæ•°æ®ä¼šè¢«å…±äº«
const { data: user1 } = useQuery({
    queryKey: ['user', 1],
    queryFn: () => fetchUser(1)
})

const { data: user2 } = useQuery({
    queryKey: ['user', 1],
    queryFn: () => fetchUser(1)
}) // user2 å°†ä½¿ç”¨ user1 çš„ç¼“å­˜æ•°æ®

```

### å¦‚ä½•è®¾ç½®ç¼“å­˜çš„è¿‡æœŸæ—¶é—´ ?
æ‰‹åŠ¨ç®¡ç†ç¼“å­˜çš„ç”Ÿå‘½å‘¨æœŸæ˜¯éå¸¸å¤æ‚ä¸”å®¹æ˜“å‡ºé”™çš„äº‹æƒ…ï¼Œåœ¨ TanStack Query ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `staleTime` å’Œ `gcTime` è½»æ¾æ§åˆ¶æ•°æ®çš„ç¼“å­˜è¡Œä¸ºï¼š

- `staleTime` è¡¨ç¤ºæ•°æ®å¤šä¹…ä¹‹åä¼šè¢«è§† "è¿‡æœŸ"ã€‚åœ¨è¿™æ®µæ—¶é—´å†…ï¼Œå¦‚æœå†æ¬¡è§¦å‘è¯¥è¯·æ±‚ï¼Œä¼šç›´æ¥ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œè€Œä¸ä¼šé‡æ–°å‘èµ·è¯·æ±‚ã€‚
- `gcTime` è¡¨ç¤ºæ•°æ®åœ¨ç¼“å­˜ä¸­ä¿ç•™çš„æ—¶é—´ã€‚


```jsx
const { data } = useQuery({
    queryKey: ['todos'],
    queryFn: fetchTodos,
    staleTime: 5 * 60 * 1000, // æ•°æ®åœ¨ 5 åˆ†é’Ÿå†…ä¿æŒæ–°é²œ
    gcTime: 10 * 60 * 1000,   // æœªä½¿ç”¨çš„æ•°æ®åœ¨ 10 åˆ†é’Ÿåè¢«åƒåœ¾å›æ”¶
})

```

<Callout type='warn' title="å»ºè®®">
- é»˜è®¤æƒ…å†µä¸‹ï¼Œ`staleTime` ä¸º `0`ï¼Œæ„å‘³ç€æ•°æ®åœ¨è·å–åç«‹å³è¿›å…¥ "è¿‡æœŸ" çŠ¶æ€ï¼Œæ¯æ¬¡éƒ½ä¼šé‡æ–°è¯·æ±‚ã€‚
- ç¼“å­˜æ—¶é—´çš„è®¾ç½®åº”è¯¥æ ¹æ®ä¸šåŠ¡å®é™…æƒ…å†µä¸äº§å“ã€åç«¯ã€æµ‹è¯•åŒå­¦æ²Ÿé€šç¡®å®šï¼Œé¿å…æ‹è„‘è¢‹å¼çš„åˆ¤æ–­ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´ç¼“å­˜å¤±æ•ˆæˆ–æ•°æ®ä¸åŒæ­¥çš„é—®é¢˜ã€‚
</Callout>

### æ‰‹åŠ¨æ›´æ–°ç¼“å­˜
TanStack Query æä¾›äº†å¤šç§æ–¹å¼æ¥æ‰‹åŠ¨æ›´æ–°ç¼“å­˜æ•°æ®ï¼š

1. **ä½¿ç”¨ **`setQueryData`** ç›´æ¥æ›´æ–°**ï¼š

```jsx
const queryClient = useQueryClient();

// æ›´æ–°å•ä¸ªæŸ¥è¯¢çš„ç¼“å­˜
queryClient.setQueryData(['todos'], (oldData) => {
    return oldData.map(todo =>
        todo.id === updatedTodo.id ? updatedTodo : todo
    )
})

```

2. **ä½¿ç”¨ **`invalidateQueries`** ä½¿ç¼“å­˜å¤±æ•ˆ**ï¼š

```jsx
// ä½¿ç‰¹å®šæŸ¥è¯¢çš„ç¼“å­˜å¤±æ•ˆ
queryClient.invalidateQueries({ queryKey: ['todos'] })

// ä½¿å¤šä¸ªç›¸å…³æŸ¥è¯¢çš„ç¼“å­˜å¤±æ•ˆ
queryClient.invalidateQueries({ queryKey: ['todos', 'lists'] })

```

3. **ä½¿ç”¨ **`prefetchQuery`** é¢„å–æ•°æ®**ï¼š

```jsx
// é¢„å–æ•°æ®åˆ°ç¼“å­˜
queryClient.prefetchQuery({
    queryKey: ['todos'],
    queryFn: fetchTodos,
})

```

4. **åˆ©ç”¨å›è°ƒç®¡ç†ç¼“å­˜**

å¯ä»¥é€šè¿‡ `onSuccess`ã€`onError` ç­‰å›è°ƒåœ¨å˜æ›´å®Œæˆåæ›´æ–°ç¼“å­˜ï¼š

```tsx
const { mutate } = useMutation({
  mutationFn: () => axios.post("/api/user", { name: "jack" })
  onSuccess: (newUser) => {
    toast.success("ç”¨æˆ·åˆ›å»ºæˆåŠŸ");

    // æ–¹æ³• 1ï¼šåˆ›å»ºç”¨æˆ·æˆåŠŸåï¼Œæ›´æ–°ç¼“å­˜ä¸­çš„ç”¨æˆ·åˆ—è¡¨
    queryClient.setQueryData(["users", newUser.id], newUser)

    // æ–¹æ³• 2ï¼šåˆ›å»ºç”¨æˆ·æˆåŠŸåï¼Œè®©ä¹‹å‰çš„ç¼“å­˜æ•°æ®å¤±æ•ˆï¼Œå¹¶é‡æ–°è·å–æ•°æ®ï¼ˆå³åˆ·æ–°ç¼“å­˜ï¼‰
    queryClient.invalidateQueries({ queryKey: ["users"] })
  }
})
```


### ç¼“å­˜ä»€ä¹ˆæ—¶å€™ä¼šè‡ªåŠ¨æ›´æ–°?

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå³ä½¿ç¼“å­˜å·²ç»è¿‡æœŸï¼Œreact-query ä¹Ÿä¸ä¼šç«‹å³é‡æ–°è¯·æ±‚ï¼Œåªæœ‰åœ¨æ»¡è¶³ä»¥ä¸‹å‡ ç§æƒ…å†µæ—¶æ‰ä¼šè§¦å‘**è‡ªåŠ¨æ›´æ–°**ï¼š

1. `queryKey` å‘ç”Ÿå˜åŒ–ï¼šä¾‹å¦‚åˆ†é¡µåˆ—è¡¨ä¸­é¡µç å˜åŒ– (å¦‚ï¼š`['todo', page]`);
2. ç»„ä»¶é‡æ–°æŒ‚è½½å¹¶è®¢é˜…äº†è¯¥ query: ä¾‹å¦‚ä¸€ä¸ªå¼•ç”¨äº†è¿‡æœŸç¼“å­˜çš„ Modalï¼Œ Modal é‡æ–°æ¸²æŸ“æ—¶ä¼šè§¦å‘æ›´æ–°ç¼“å­˜ï¼›
3. æµè§ˆå™¨çª—å£é‡æ–°è·å–ç„¦ç‚¹ï¼šç”¨æˆ·åˆ‡æ¢æ ‡ç­¾é¡µè¿”å›åï¼›
4. è®¾å¤‡ç½‘ç»œæ–­å¼€åé‡æ–°è¿æ¥


### å¦‚ä½•å…³é—­è‡ªåŠ¨æ›´æ–°è¡Œä¸ºï¼Ÿ
TanStack Query é»˜è®¤å¯ç”¨ä¸Šè¿°åˆ·æ–°æœºåˆ¶ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ä½ å¯èƒ½å¸Œæœ›æ‰‹åŠ¨æ§åˆ¶æ›´æ–°è¡Œä¸ºã€‚

å…¶ä¸­ä¸‰ç§æƒ…å†µå¯ä»¥æ‰‹åŠ¨å…³é—­:

```ts
useQuery({
  queryKey: ['todo', sort],
  queryFn: () => fetchTodo(sort),
  staleTime: 30 * 1000, // ç¼“å­˜30ç§’
  refetchOnMount: false,         // ç»„ä»¶æŒ‚è½½æ—¶ä¸è‡ªåŠ¨åˆ·æ–°
  refetchOnWindowFocus: false,   // èšç„¦çª—å£æ—¶ä¸åˆ·æ–°
  refetchOnReconnect: false,     // ç½‘ç»œé‡è¿æ—¶ä¸åˆ·æ–°
})
```
- ä½ ä¹Ÿå¯ä»¥é€šè¿‡å°† `staleTime` è®¾ç½®ä¸º `Infinity` æ¥æ°¸ä¸è¿‡æœŸï¼Œé™¤éæ‰‹åŠ¨è§¦å‘åˆ·æ–°ã€‚

**ç¤ºä¾‹ï¼šå±•ç¤ºæ•°æ®åŠæ›´æ–°æ—¶é—´ï¼Œå¹¶æ‰‹åŠ¨åˆ·æ–°**

ä¸‹é¢æ˜¯ä¸€ä¸ªå°ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ç¼“å­˜å’Œæ›´æ–°é€»è¾‘ï¼š

- ä½¿ç”¨ useQuery è·å–æ•°æ®ï¼›
- è®¾ç½® `staleTime` ä¸º 30 ç§’ï¼›
- æ˜¾ç¤ºå½“å‰æ•°æ®å’Œä¸Šæ¬¡æ›´æ–°æ—¶é—´ï¼›
- 5 ç§’åå‡ºç° ã€Œåˆ·æ–°æ•°æ®ã€ æŒ‰é’®ï¼Œç”¨æˆ·å¯ä»¥æ‰‹åŠ¨è§¦å‘æ›´æ–°ï¼›
- è§‚å¯Ÿ `isStale`ï¼ˆæ•°æ®æ˜¯å¦è¿‡æœŸï¼‰ä¸ isFetchingï¼ˆæ˜¯å¦æ­£åœ¨è¯·æ±‚ï¼‰çŠ¶æ€ã€‚

import TodoList from './examples/react-query-cache';

 <CodeDisplay component={<TodoList />}>
  <include lang="tsx" meta={{title: "opacity.tsx"}}>
   ./examples/react-query-cache.tsx
  </ include>
</CodeDisplay>

### ä¹è§‚æ›´æ–°
> ä¹è§‚æ›´æ–°æ˜¯ä¸€ç§æå‡ç”¨æˆ·ä½“éªŒçš„æŠ€æœ¯ï¼Œå®ƒå‡è®¾æ›´æ–°ä¼šæˆåŠŸï¼Œç«‹å³æ›´æ–° UIï¼Œç„¶ååœ¨åå°è¿›è¡Œå®é™…çš„æ›´æ–°æ“ä½œï¼š


<div>æ­£å¸¸æµç¨‹ï¼šç”¨æˆ·ç‚¹å‡» â†’ æ˜¾ç¤º loading â†’ ç­‰å¾…åç«¯è¿”å› â†’ æ›´æ–°çŠ¶æ€ ï¼ˆâš ï¸ ç”¨æˆ·ä½“éªŒå¾ˆä¸æµç•…ï¼‰</div>
<div>ä¹è§‚æ›´æ–°ï¼šç”¨æˆ·ç‚¹å‡» â†’ ç«‹å³æ›´æ–° UI â†’ ç­‰å¾…åç«¯è¿”å› â†’ æˆåŠŸåˆ™ä¿ç•™ï¼Œå¤±è´¥åˆ™å›æ»šå¹¶æç¤º</div>

ä»¥ä¸‹è¿™äº›åœºæ™¯éå¸¸é€‚åˆä½¿ç”¨ä¹è§‚æ›´æ–°ï¼š
- ç‚¹èµ / æ”¶è—
- å…³æ³¨ / å–å…³
- è¯„è®º / åˆ é™¤
- æ‹–æ‹½æ’åºç­‰å³æ—¶ UI å“åº”æ“ä½œ


#### å®ç°æ€è·¯ onMutate + å›æ»š

```tsx
onMutate: async ({ targetData }) => {
  const snapshot = queryClient.getQueryData(queryKey)

  // ä¹è§‚æ›´æ–° 
  queryClient.setQueryData(queryKey, (oldData) => {
    return newData;
  })

  // è¿”å›ä¸€ä¸ªå›æ»šå‡½æ•°
  return () => queryClient.setQueryData(queryKey, snapshot)
},

onError: (err, variables, rollback) => {
  // rollback å°±æ˜¯ onMutate çš„è¿”å›å€¼ï¼Œä¹Ÿå°±æ˜¯å›æ»šæ–¹æ³•ã€‚
  rollback?.()
},

onSettled: () => {
  // æ— è®ºæ¥å£æˆåŠŸä¸å¦ï¼Œéƒ½ä¼šæ‰§è¡Œã€‚æˆ‘ä»¬å¯ä»¥åœ¨é‡Œé¢è°ƒç”¨ `invalidateQueries`ï¼Œåˆ·æ–°ç¼“å­˜ã€‚
  queryClient.invalidateQueries({ queryKey })
}
```

#### ç¤ºä¾‹

```jsx
import { Button } from 'antd'
import { useMutation, useQueryClient } from '@tanstack/react-query'

interface Todo {
    id: number
    title: string
    completed: boolean
}

const updateTodo = async (newTodo: Todo) => {
    // Implement the logic to update a todo item
    // For example, you can make a POST request to a server
    const response = await fetch('/api/todos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newTodo)
    })
    return response.json()
};

export default function TodoList() {
    const queryClient = useQueryClient()

    const mutation = useMutation({
        mutationFn: updateTodo,
        onMutate: async (newTodo) => {
            // å–æ¶ˆä»»ä½•ä¼ å‡ºçš„é‡æ–°è·å–
            await queryClient.cancelQueries({ queryKey: ['todos'] })

            // ä¿å­˜ä¹‹å‰çš„æ•°æ®
            const previousTodos = queryClient.getQueryData(['todos'])

            // ä¹è§‚æ›´æ–°
            queryClient.setQueryData(['todos'], (old: Todo[]) => [...old, newTodo])

            // è¿”å›ä¸Šä¸‹æ–‡å¯¹è±¡
            return { previousTodos }
        },
        onError: (err, _, context) => {
            console.log('ğŸš€ ~ TodoList ~ err:', err)
            // å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œå›æ»šåˆ°ä¹‹å‰çš„æ•°æ®
            if (context?.previousTodos) {
                queryClient.setQueryData(['todos'], context.previousTodos)
            }
        },
        onSettled: () => {
            // æ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½é‡æ–°è·å–æ•°æ®
            queryClient.invalidateQueries({ queryKey: ['todos'] })
        },
    });

    return (
        <div>
            {mutation.isPending ? (
                'Adding todo...'
            ) : (
                <>
                    {mutation.isError ? (
                        <div>An error occurred: {mutation.error.message}</div>

                    ) : null}

                    {mutation.isSuccess ? <div>Todo added!</div> : null}

                    <Button
                        onClick={() => {
                            mutation.mutate({ id: Date.now(), title: 'New Todo', completed: false });
                        }}
                    >
                        Create Todo
                    </Button>

                </>
            )}
        </div>
    )
}
```


#### å°è£…é€šç”¨ Hook

è‹¥ä½ é¡¹ç›®ä¸­å¤šæ¬¡ä½¿ç”¨ä¹è§‚æ›´æ–°ï¼Œå¯ä»¥å°è£…ä¸€ä¸ªç»Ÿä¸€çš„ Hookã€‚

> ä½†æˆ‘è§‰å¾—ä¸€ä¸ªé¡¹ç›®ä¸­æ¶‰åŠåˆ°ä¹è§‚æ›´æ–°çš„åœ°æ–¹å…¶å®å¹¶ä¸å¤šï¼ŒåŸºäº `useMutate` è°ƒç”¨`onMutate`ï¼Œ`onError`ï¼Œ`onSettled` ç­‰æ–¹æ³•ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°ä¹è§‚æ›´æ–°ã€‚å°è£…äº† Hook åï¼Œåè€Œå¢åŠ äº†ä»£ç çš„å¤æ‚åº¦ã€‚

```tsx

type UseOptimisticMutationParams<TData = unknown> = {
  mutationFn: MutationFunction<TData, any>
  queryKey: QueryKey
  updater: (oldData: any) => any
  invalidates?: QueryKey
};

export const useOptimisticMutation = <TData>({
  mutationFn,
  queryKey,
  updater,
  invalidates = queryKey,
}: UseOptimisticMutationParams<TData>) => {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn,
    onMutate: async () => {
      // å–æ¶ˆä»»ä½•ç›¸å…³è¯·æ±‚ï¼Œé¿å…è¦†ç›–ç»“æœ
      await queryClient.cancelQueries({ queryKey })

      const snapshot = queryClient.getQueryData(queryKey)
      queryClient.setQueryData(queryKey, updater)

      return () => queryClient.setQueryData(queryKey, snapshot)
    },
    onError: (err, variables, rollback) => {
      rollback?.()
    },
    onSettled: () => {
      queryClient.invalidateQueries({ queryKey: invalidates })
    }
  })
}
```


### ç¼“å­˜æŒä¹…åŒ–
åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å°†ç¼“å­˜æ•°æ®æŒä¹…åŒ–åˆ°æœ¬åœ°å­˜å‚¨ï¼š

```jsx
import { persistQueryClient } from '@tanstack/react-query-persist-client';
import { createSyncStoragePersister } from '@tanstack/query-sync-storage-persister';

// åˆ›å»ºæŒä¹…åŒ–å­˜å‚¨
const persister = createSyncStoragePersister({
    storage: window.localStorage,
});

// é…ç½®æŒä¹…åŒ–
persistQueryClient({
    queryClient,
    persister,
    maxAge: 1000 * 60 * 60 * 24 // 24 å°æ—¶
});

```

### ç¼“å­˜è°ƒè¯•
TanStack Query æä¾›äº†å¼€å‘è€…å·¥å…·æ¥å¸®åŠ©è°ƒè¯•ç¼“å­˜ï¼Œ`@tanstack/react-query-devtools` å°±æ˜¯ä¸“é—¨æ¥åšè°ƒè¯•çš„ï¼Œåœ¨é…ç½®ä¹‹å‰ï¼Œéœ€è¦å…ˆå®‰è£…ï¼š

```jsx
pnpm add @tanstack/react-query-devtools
```

åœ¨å…¥å£æ–‡ä»¶çš„é…ç½®å¦‚ä¸‹ï¼š

```jsx
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';

function App() {
    return (
        <>
            {/* ä½ çš„åº”ç”¨ç»„ä»¶ */}
            <ReactQueryDevtools initialIsOpen={false} />
        </>
    );
}

```

é…ç½®æˆåŠŸåï¼Œé»˜è®¤ä¼šåœ¨ç½‘é¡µçš„å³ä¸‹è§’æ˜¾ç¤ºä¸€ä¸ªæŒ‰é’®ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š

![](./images/devtool.png)

é€šè¿‡åˆç†ä½¿ç”¨è¿™äº›ç¼“å­˜å’Œæ›´æ–°æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š

1. å‡å°‘ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚
2. æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
3. å®ç°ç¦»çº¿åŠŸèƒ½
4. ä¼˜åŒ–åº”ç”¨æ€§èƒ½

## å…­ã€å¤„ç†åˆ†é¡µå’Œæ— é™æ»šåŠ¨
åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¸ä¼šä¸€æ¬¡æ€§æŠŠå…¨éƒ¨æ•°æ®è¯·æ±‚å›æ¥ï¼Œè€Œæ˜¯è¿›å…¥ä¸åŒé¡µç æ—¶æ‰è¯·æ±‚å¯¹åº”çš„æ•°æ®ã€‚åœ¨å¤„ç†å¤§é‡æ•°æ®æ—¶ï¼Œåˆ†é¡µå’Œæ— é™æ»šåŠ¨æ˜¯ä¸¤ç§å¸¸ç”¨çš„æ•°æ®åŠ è½½æ–¹å¼ã€‚TanStack Query æä¾›äº†ä¸“é—¨çš„é’©å­æ¥å¤„ç†è¿™äº›åœºæ™¯ã€‚


### åˆ†é¡µæŸ¥è¯¢

åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œåˆ†é¡µæ¥å£é€šå¸¸æ¥å— pageã€limit ç­‰å‚æ•°ï¼Œå¹¶è¿”å›å¦‚ä¸‹ç»“æ„çš„æ•°æ®ï¼š

```json
{
  "cur_page": 1,
  "total": 500,
  "data": [...]
}
```

æœ€ç›´è§‚çš„å®ç°æ˜¯ä¸ºæ¯ä¸€é¡µä½¿ç”¨ä¸åŒçš„ `queryKey`ï¼Œä¾‹å¦‚ï¼š

```ts
useQuery({
  queryKey: ['books', page],
  queryFn: () => fetchBooks(page)
})
```

**ç¤ºä¾‹æ¼”ç¤º**

import PaginationDemo from './examples/06-pagination.tsx';

 <CodeDisplay component={<PaginationDemo />}>
  <include lang="tsx" >
   ./examples/06-pagination.tsx
  </ include>
</CodeDisplay>

![](./images/pagination.png)

è¡Œä¸Šå›¾çš„å³ä¾§ `network` é¢æ¿ä¹Ÿèƒ½çœ‹åˆ°ï¼Œæ¯é¡µè¯·æ±‚ `10` æ¡æ•°æ®ï¼Œå·²ç»è®¿é—®è¿‡çš„é¡µç ï¼Œä¸ä¼šå†æ¬¡é‡æ–°è¯·æ±‚ï¼Œä¸»è¦é…ç½®å°±æ˜¯ `placeholderData` å’Œ `keepPreviousData` !


### æ— é™æ»šåŠ¨
> æ— é™æ»šåŠ¨åœºæ™¯å¸¸ç”¨äºç”¨æˆ·æ»‘åŠ¨åˆ°åº•éƒ¨æ—¶è‡ªåŠ¨åŠ è½½ä¸‹ä¸€é¡µï¼Œä¾‹å¦‚åšå®¢ã€å•†å“åˆ—è¡¨ã€è¯„è®ºåŒºç­‰ã€‚

å¯¹äºæ— é™æ»šåŠ¨ï¼ŒTanStack Query æä¾›äº† `useInfiniteQuery` é’©å­ã€‚è¿™ä¸ªé’©å­ä¸“é—¨ç”¨äºå¤„ç†æ— é™åŠ è½½çš„æ•°æ®ã€‚


#### åŸºæœ¬ç”¨æ³•

```ts
const { data, hasNextPage, fetchNextPage } = useInfiniteQuery({
  queryKey: ['books', sort],
  initialPageParam: 1,
  queryFn: ({ pageParam = 1 }) => fetchBooks(sort, pageParam),
  getNextPageParam: (lastPage) => {
    return lastPage.cur_page < lastPage.total
      ? lastPage.cur_page + 1
      : undefined
  }
})
```

æ¸²æŸ“åˆ†é¡µæ•°æ®ï¼š

```tsx
<ul>
  {data.pages.map((page) =>
    page.data.map((item) => <li key={item.id}>{item.name}</li>)
  )}
</ul>

<button onClick={() => fetchNextPage()} disabled={!hasNextPage}>
  ä¸‹ä¸€é¡µ
</button>
```

<Callout type='warn' title="æ³¨æ„" >
ä¸Šè¿°å®šä¹‰æ˜¯ä¸å‡†ç¡®çš„ï¼Œå› ä¸ºè¿˜æœ‰ä¸€ç§å¯èƒ½æ˜¯ç”¨æˆ·å‘ä¸Šæ»šåŠ¨æ—¶ï¼Œè‡ªåŠ¨åŠ è½½ä¸Šä¸€é¡µçš„æ•°æ®ã€‚æ‰€ä»¥æ— é™æ»šåŠ¨éœ€è¦æ”¯æŒåŒå‘è·å–æ•°æ®ï¼ˆæ¯”å¦‚è·å–èŠå¤©è®°å½•ï¼‰è®°å¾—ä¸º `prefetchQuery` æä¾› `staleTime` å‚æ•°ï¼Œå®ƒè¡¨ç¤ºç¼“å­˜æ•°æ®çš„æœ‰æ•ˆæ—¶é—´ï¼Œèƒ½æœ‰æ•ˆé¿å…è¿‡äºé¢‘ç¹çš„ç½‘ç»œè¯·æ±‚ã€‚
</Callout>



#### æ”¯æŒåŒå‘åŠ è½½

éœ€è¦åŒæ—¶å®ç° `getPreviousPageParam`:

```tsx
useInfiniteQuery({
  queryKey: ["books", sort],
  initialPageParam: { page: 1 },
  queryFn: ({ pageParam = 1 }) => fetchBooks(sort, pageParam),
   getNextPageParam: (lastPage) => {
    const nextPage = lastPage.cur_page + 1
    return nextPage <= lastPage.total ? { page: nextPage } : undefined
  },
  getPreviousPageParam: (firstPage) => {
    const prevPage = firstPage.cur_page - 1
    return prevPage >= 1 ? { page: prevPage } : undefined
  }
})
```

<Callout type='warn' title="æ³¨æ„" >
- æ­¤æ—¶ `useInfiniteQuery` è¿”å›å€¼çš„ `data` ä¸å†ä¸æ˜¯ `queryFn` è¿”å›çš„æ•°æ®ï¼Œè€Œæ˜¯åŒ…å«å¤šä¸ªåˆ†é¡µå†…å®¹çš„ `pages` æ•°ç»„ã€‚
- `pages` è¡¨ç¤ºç›®å‰å·²è·å–çš„æ‰€æœ‰é¡µçš„æ•°æ®çš„é›†åˆã€‚
- `useInfiniteQuery` è¿”å›çš„ `refetch` å°†ä¼šé‡æ–°è¯·æ±‚æ‰€æœ‰åˆ†é¡µæ•°æ®ï¼Œè€Œéä»…åˆ·æ–°å½“å‰é¡µã€‚
- è¿™æ˜¯å› ä¸ºå½“æŸä¸€é¡µæ•°æ®å‘ç”Ÿå˜æ›´ï¼Œå¯èƒ½åç»­ï¼ˆæˆ–å‰é¢ï¼‰çš„æ¯ä¸€é¡µéƒ½éšç€å‘ç”Ÿå˜æ›´ã€‚
</Callout>


#### ç¤ºä¾‹æ¼”ç¤º

åœ¨å®ç°æ— é™æ»šåŠ¨æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦æ£€æµ‹å…ƒç´ æ˜¯å¦è¿›å…¥è§†å£ï¼ˆviewportï¼‰ï¼Œè¿™æ—¶å°±éœ€è¦ç”¨åˆ° `react-intersection-observer` è¿™ä¸ªåº“ã€‚
`react-intersection-observer` æ˜¯ä¸€ä¸ª React ç»„ä»¶å’Œé’©å­ï¼Œç”¨äºæ£€æµ‹å…ƒç´ æ˜¯å¦è¿›å…¥è§†å£ã€‚å®ƒåŸºäº [Intersection Observer API](https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FIntersection_Observer_API)ï¼Œæä¾›äº†ä¸€ç§ç®€å•çš„æ–¹å¼æ¥ç›‘æ§å…ƒç´ ä¸è§†å£çš„äº¤å‰çŠ¶æ€ã€‚

ä¸»è¦ç‰¹ç‚¹ï¼š

1. ä½¿ç”¨ç®€å•ï¼šæä¾›äº† `useInView` é’©å­ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿
2. æ€§èƒ½å¥½ï¼šåŸºäºåŸç”Ÿçš„ Intersection Observer APIï¼Œæ€§èƒ½å¼€é”€å°
3. å¯é…ç½®ï¼šæ”¯æŒå¤šç§é…ç½®é€‰é¡¹ï¼Œå¦‚é˜ˆå€¼ã€æ ¹å…ƒç´ ç­‰
4. è·¨æµè§ˆå™¨å…¼å®¹ï¼šè‡ªåŠ¨å¤„ç†æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜


åŸºæœ¬ç”¨æ³•ï¼š

```jsx
import { useInView } from 'react-intersection-observer';

function MyComponent() {
    const { ref, inView } = useInView({
        threshold: 0, // è§¦å‘é˜ˆå€¼ï¼Œ0 è¡¨ç¤ºå…ƒç´ åˆšè¿›å…¥è§†å£å°±è§¦å‘
        triggerOnce: false, // æ˜¯å¦åªè§¦å‘ä¸€æ¬¡
    });

  return (
      <div ref={ref}>
          {inView ? 'å…ƒç´ åœ¨è§†å£ä¸­' : 'å…ƒç´ ä¸åœ¨è§†å£ä¸­'}
      </div>

  );
}

```

åœ¨æˆ‘ä»¬çš„æ— é™æ»šåŠ¨å®ç°ä¸­ï¼Œ`react-intersection-observer` ç”¨äºæ£€æµ‹åŠ è½½æ›´å¤šè§¦å‘å™¨æ˜¯å¦è¿›å…¥è§†å£ï¼Œä»è€Œè§¦å‘åŠ è½½ä¸‹ä¸€é¡µæ•°æ®çš„æ“ä½œã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ `useInfiniteQuery` å’Œ `react-intersection-observer` å®ç°çš„æ— é™æ»šåŠ¨å•†å“åˆ—è¡¨ï¼š


import ScrollDemo from './examples/07-Infinite-scrolling.tsx';

 <CodeDisplay component={<ScrollDemo />}>
  <include lang="tsx" >
   ./examples/07-Infinite-scrolling.tsx
  </ include>
</CodeDisplay>

å½“æ»šåŠ¨æ¡åˆ’åˆ°åº•éƒ¨çš„æ—¶å°±è‡ªåŠ¨å»è·å–ä¸‹ä¸€é¡µçš„æ•°æ®ï¼Œå¦‚ä¸‹å›¾ï¼š

![](./images/scroll.gif)


### åˆ†é¡µä¸æ— é™æ»šåŠ¨çš„é€‰æ‹©
é€‰æ‹©ä½¿ç”¨åˆ†é¡µè¿˜æ˜¯æ— é™æ»šåŠ¨å–å†³äºå…·ä½“çš„åº”ç”¨åœºæ™¯ï¼š

1. **åˆ†é¡µé€‚ç”¨äº**ï¼š
    - éœ€è¦ç²¾ç¡®æ§åˆ¶æ¯é¡µæ˜¾ç¤ºæ•°é‡çš„åœºæ™¯
    - éœ€è¦å¿«é€Ÿè·³è½¬åˆ°ç‰¹å®šé¡µé¢çš„åœºæ™¯
    - æ•°æ®é‡ç›¸å¯¹è¾ƒå°ä¸”ç»“æ„åŒ–çš„åœºæ™¯
2. **æ— é™æ»šåŠ¨é€‚ç”¨äº**ï¼š
    - å†…å®¹æµå¼çš„åœºæ™¯ï¼ˆå¦‚ç¤¾äº¤åª’ä½“ï¼‰
    - éœ€è¦æŒç»­åŠ è½½æ›´å¤šå†…å®¹çš„åœºæ™¯
    - ç§»åŠ¨ç«¯åº”ç”¨

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### 1. ä½¿ç”¨ `placeholderData` ä¿ç•™ä¸Šä¸€é¡µæ•°æ®

ä¼¼ä¹å¹³å¸¸çš„ `useQuery` å°±å¯ä»¥è§£å†³åˆ†é¡µçš„éœ€æ±‚ï¼Œä½†æ¯æ¬¡ç¿»é¡µè·å–æ–°æ•°æ®éƒ½ä¼šå› ä¸º key çš„æ”¹å˜ï¼Œä½¿` data` å˜æˆç©ºæ•°æ®ï¼Œå¯¼è‡´é¡µé¢æŠ–åŠ¨ã€‚

`placeholderData` æ”¯æŒæ¥æ”¶ä¸Šä¸€æ¬¡çš„æ•°æ®ä½œä¸ºå‚æ•°ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨åŠ è½½æ–°é¡µæ—¶æ˜¾ç¤ºä¸Šä¸€é¡µå†…å®¹ï¼Œä»è€Œé¿å…ç©ºç™½é—ªåŠ¨ã€‚

æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹ï¼šè®©åŠ è½½æ–°æ•°æ®æ—¶ä¸å†ç›´æ¥è¿”å›ç©ºæ•°æ®ï¼Œè€Œæ˜¯ä¿ç•™ä¸Šä¸€é¡µçš„æ•°æ®ï¼Œé…åˆä¸€ä¸ªç®€å•çš„åŠé€æ˜æ»¤é•œæ•ˆæœè¡¨æ˜æ­£åœ¨åŠ è½½å°±å¯ä»¥åœ¨ä¿è¯æœ‰å“åº”çš„åŒæ—¶å‡å°‘é¡µé¢æŠ–åŠ¨ï¼š


```tsx
const { data, isPlaceholderData } = useQuery({
  queryKey: ['books', page],
  queryFn: () => fetchBooks(page),
  placeholderData: (prev) => prev
})
```

ç»“åˆç®€å•æ ·å¼å¤„ç†å³å¯å®ç° ã€Œæ¸éšåŠ è½½ã€ çš„æ•ˆæœï¼š

```tsx
<ul style={{ opacity: isPlaceholderData ? 0.5 : 1 }}>
  {data.data.map((it) => (
    <li key={it.id}>{it.name}</li>
  ))}
</ul>
```

#### 2. ç¦ç”¨åˆ‡é¡µæŒ‰é’®ä»¥é¿å…å¼‚å¸¸è¡Œä¸º

ä¸ºäº†é˜²æ­¢é‡å¤è¯·æ±‚æˆ–è¶Šç•Œè¯·æ±‚ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šæƒ³åœ¨æ–°æ•°æ®åŠ è½½æ—¶ç¦ç”¨ç¿»é¡µæŒ‰é’®ï¼š

```ts
const { isPlaceholderData } = useBooksQuery(sort, page)

const prevDisabled = page === 1 || isPlaceholderData
const nextDisabled = page === data.total || isPlaceholderData
```


#### 3. ä½¿ç”¨ `keepPreviousData`ï¼š

```jsx
const { data } = useQuery({
    queryKey: ['products', pagination],
    queryFn: () => fetchProducts(pagination),
    placeholderData: keepPreviousData, // åœ¨åŠ è½½æ–°æ•°æ®æ—¶ä¿ç•™æ—§æ•°æ®
});

```

#### 4. é…åˆ `prefetchQuery` é¢„å–ä¸‹ä¸€é¡µæ•°æ®ï¼š

æˆ‘ä»¬è¿˜å¯ä»¥åœ¨è¿›å…¥å½“å‰é¡µæ—¶ï¼Œç»“åˆä¸Šä¸€ç¯‡æ–‡ç« ä»‹ç»çš„ `prefetchQuery`ï¼Œé¢„å…ˆåŠ è½½ä¸‹ä¸€é¡µæ•°æ®ï¼ŒåŠ å¿«ç¿»é¡µå“åº”é€Ÿåº¦ï¼š


```jsx
const queryClient = useQueryClient();

// é¢„å–ä¸‹ä¸€é¡µæ•°æ®
queryClient.prefetchQuery({
    queryKey: ['products', { page: pagination.page + 1, limit: pagination.limit }],
    queryFn: () => fetchProducts({ page: pagination.page + 1, limit: pagination.limit }),
});

```

```ts
const getBooksQueryOptions = (sort: string, page: number) => ({
  queryKey: ['books', sort, page],
  queryFn: () => fetchBooks(sort, page),
  staleTime: 5 * 60 * 1000 // ç¼“å­˜ 5 åˆ†é’Ÿ
})

const useBooksQuery = (sort: string, page: number) => {
  const queryClient = useQueryClient()
  // é¢„åŠ è½½ä¸‹ä¸€é¡µ
  useEffect(() => {
    queryClient.prefetchQuery(getBooksQueryOptions(sort, page + 1))
  }, [sort, page])
  return useQuery(getBooksQueryOptions(sort, page))
}
```


#### 5. **ä½¿ç”¨ **`staleTime`** æ§åˆ¶æ•°æ®æ–°é²œåº¦**ï¼š

```jsx
const { data } = useQuery({
    queryKey: ['products', pagination],
    queryFn: () => fetchProducts(pagination),
    staleTime: 5 * 60 * 1000, // ç¼“å­˜5åˆ†é’Ÿæ•°æ®
});

```



## ä¸ƒã€è®¢é˜…ä¸å®æ—¶æ•°æ®
åœ¨å®æ—¶åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å¤„ç†å®æ—¶æ•°æ®æ›´æ–°ã€‚TanStack Query æä¾›äº†å¤šç§æ–¹å¼æ¥å¤„ç†å®æ—¶æ•°æ®ï¼ŒåŒ…æ‹¬è½®è¯¢ã€WebSocket è®¢é˜…ç­‰ã€‚ä¸‹é¢é€šè¿‡ä¸€ä¸ªå•†å“åº“å­˜åˆ°è´§é€šçŸ¥çš„ä¾‹å­æ¥å±•ç¤º TanStack Query ä¸­å¦‚ä½•ä½¿ç”¨ WebSocketã€‚

### WebSocket æœåŠ¡å™¨å®ç°
ä¸‹é¢ä»¥ç®€æ˜“èŠå¤©ç³»ç»Ÿä¸ºä¾‹ï¼Œæ¥çœ‹çœ‹æ€ä¹ˆå°† TanStack Query è·Ÿ WS ç»“åˆèµ·æ¥ï¼Œæœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š

![](./images/websocket-demo.png)

æœåŠ¡ç«¯ä»£ç å®ç°å¦‚ä¸‹ï¼š

  <include lang="ts" >
   ../../../src/app/(examples)/demo/websocket/websocket-server.ts
  </ include>


ä½¿ç”¨å‘½ä»¤ `npx tsx ./server/websocket.ts` è¿è¡ŒæœåŠ¡ç«¯ä»£ç å¦‚ä¸‹ï¼š ![](./images/websocket.png)

### å‰ç«¯å®ç°
å‰ç«¯ä¸€å…±å°±ä¸¤ä¸ªç‚¹ï¼šè¿æ¥ WS å’Œå±•ç¤ºç”¨æˆ·çš„ä¿¡æ¯ï¼Œç°åœ¨ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä½¿ç”¨ chat çš„ React ç»„ä»¶æ¥å±•ç¤ºèŠå¤©æ•°æ®ï¼š


  <include lang="tsx" >
   ../../../src/app/(examples)/demo/websocket/page.tsx
  </ include>


ä¸Šé¢çš„ç»„ä»¶ä¸­ï¼Œå¼•å…¥äº†ä¸€ä¸ªå…³é”®çš„ Hooksâ€”â€”`useWebSocket`ï¼Œç”¨äºå»ºç«‹ä¸€ä¸ª WebSocket è¿æ¥åˆ°æŒ‡å®šçš„ URL çš„æœåŠ¡å™¨ã€‚è¿™ä¸ªé’©å­æä¾›äº†ä¸€ç³»åˆ—å‡½æ•°å’ŒçŠ¶æ€å˜é‡æ¥ç®¡ç†è¿æ¥å’Œä¸æœåŠ¡å™¨é€šä¿¡ã€‚å…·ä½“åŠŸèƒ½æœ‰ï¼šè¿æ¥ç®¡ç†ã€çŠ¶æ€ç®¡ç†ã€æ¶ˆæ¯æ”¶å‘ã€TanStack Query é›†æˆå’Œç»„ä»¶å¸è½½æ—¶æ¸…ç† WebSocket è¿æ¥å’Œé—´éš”ã€‚ä»£ç å®ç°å¦‚ä¸‹ï¼š


  <include lang="tsx" >
   ../../../src/app/(examples)/demo/websocket/use-websocket.tsx
  </ include>

### å®ç°è¯´æ˜
1. **WebSocket æœåŠ¡å™¨**ï¼š
    - ä½¿ç”¨ `ws` åº“åˆ›å»º WebSocket æœåŠ¡å™¨
    - ç»´æŠ¤è¿æ¥çš„å®¢æˆ·ç«¯åˆ—è¡¨
    - æš‚å­˜å®¢æˆ·ç«¯å‘é€çš„ä¿¡æ¯
    - å¹¿æ’­æ›´æ–°ç»™æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯
2. **å‰ç«¯å®ç°**ï¼š
    - ä½¿ç”¨ `useQuery` è·å–åˆå§‹æ•°æ®
    - ä½¿ç”¨ `useEffect` å»ºç«‹ WebSocket è¿æ¥
    - é€šè¿‡ `queryClient.setQueryData` æ›´æ–°ç¼“å­˜æ•°æ®
    - ä½¿ç”¨ Ant Design çš„ç»„ä»¶å±•ç¤ºæ•°æ®

è¿™ä¸ªå®ç°å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ WebSocket å’Œ TanStack Query æ¥å¤„ç†å®æ—¶æ•°æ®æ›´æ–°ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š

+ ä¿æŒæ•°æ®çš„å®æ—¶æ€§
+ å‡å°‘ä¸å¿…è¦çš„è½®è¯¢è¯·æ±‚
+ æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
+ ä¼˜åŒ–æœåŠ¡å™¨èµ„æºä½¿ç”¨



## å…«ã€æ€»ç»“
TanStack Query æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ•°æ®è·å–å’ŒçŠ¶æ€ç®¡ç†åº“ï¼Œå®ƒé€šè¿‡ä»¥ä¸‹ç‰¹æ€§æ˜¾è‘—æå‡äº†å¼€å‘æ•ˆç‡å’Œç”¨æˆ·ä½“éªŒï¼š

1. **è‡ªåŠ¨ç¼“å­˜ç®¡ç†**ï¼šæ™ºèƒ½å¤„ç†æ•°æ®ç¼“å­˜ï¼Œå‡å°‘é‡å¤è¯·æ±‚ï¼Œæå‡åº”ç”¨æ€§èƒ½ã€‚
2. **çŠ¶æ€ç®¡ç†ç®€åŒ–**ï¼šè‡ªåŠ¨å¤„ç†åŠ è½½ã€é”™è¯¯ç­‰çŠ¶æ€ï¼Œå‡å°‘æ ·æ¿ä»£ç ã€‚
3. **å®æ—¶æ•°æ®æ”¯æŒ**ï¼šé€šè¿‡ WebSocket ç­‰æœºåˆ¶æ”¯æŒå®æ—¶æ•°æ®æ›´æ–°ã€‚
4. **åˆ†é¡µä¸æ— é™æ»šåŠ¨**ï¼šå†…ç½®æ”¯æŒåˆ†é¡µå’Œæ— é™æ»šåŠ¨åœºæ™¯ï¼Œç®€åŒ–å¤æ‚æ•°æ®åŠ è½½é€»è¾‘ã€‚
5. **å¼€å‘ä½“éªŒä¼˜åŒ–**ï¼šæä¾› DevTools ç­‰å·¥å…·ï¼Œæ–¹ä¾¿è°ƒè¯•å’Œç›‘æ§ã€‚

ç”±äºç¯‡å¹…æœ‰é™ï¼Œæ²¡æœ‰æ¦‚å«æ‰€æœ‰ TanStack Query çš„å†…å®¹ï¼Œåªåˆ—ä¸¾äº†ä¸€äº›é«˜é¢‘çš„åœºæ™¯ï¼Œå¦‚æœæ„Ÿå…´è¶£ï¼Œå¯ä»¥è‡ªè¡Œé˜…è¯»å®˜ç½‘ï¼



## å…¶å®ƒ

### ç«æ€è¯·æ±‚

ç«æ€è¯·æ±‚ï¼ˆRace Conditionï¼‰æ˜¯ä¸€ä¸ªå¸¸è§é—®é¢˜ï¼Œå°¤å…¶åœ¨ç»„ä»¶å¿«é€Ÿé‡æ–°è¯·æ±‚æ•°æ®ï¼ˆå¦‚æœç´¢æ¡†ã€å¿«é€Ÿåˆ‡æ¢é¡µé¢ç­‰ï¼‰æ—¶ï¼Œ**æ—§è¯·æ±‚æ¯”æ–°è¯·æ±‚æ™šè¿”å›**ï¼Œå´é”™è¯¯åœ°è¦†ç›–äº†æ–°è¯·æ±‚çš„ç»“æœã€‚

ä¸Šè¿°æœ‰ç‚¹æŠ½è±¡ï¼Œæˆ‘ä»¬æƒ³è±¡ä¸¤ä¸ªåœºæ™¯ï¼š

1. **ç¿»é¡µäº¤äº’**ï¼šæœ‰ä¸€ä¸ªæ”¯æŒç¿»é¡µçš„è¡¨æ ¼ï¼Œå¦‚æœç”¨æˆ·ä»ç¬¬ä¸€é¡µå¿«é€Ÿçš„ç¿»åˆ°ç¬¬åé¡µã€‚æ­¤æ—¶ç”¨æˆ·æœŸæœ›çœ‹åˆ°çš„æ˜¯ç¬¬åé¡µçš„æ•°æ®ï¼Œä½†æˆ‘ä»¬ä¸èƒ½ä¿è¯ç¬¬åé¡µçš„è¯·æ±‚ä¸€å®šæ—©äºå…¶ä»–é¡µç çš„è¯·æ±‚è¿”å›ï¼Œæ‰€ä»¥ç¬¬åé¡µçš„è¯·æ±‚ç»“æœå¯èƒ½è¢«å…¶ä»–é¡µç çš„è¯·æ±‚ç»“æœè¦†ç›–ã€‚
2. **æœç´¢åŠŸèƒ½**ï¼šä¸€ä¸ªè‡ªåŠ¨å®Œæˆç»„ä»¶ï¼Œç”¨æˆ·è¾“å…¥ä¸€éƒ¨åˆ†å†…å®¹ï¼Œç»„ä»¶ä¼šç«‹å³è®¿é—®è¿œç¨‹æœåŠ¡å™¨è·å–æ™ºèƒ½è¡¥å…¨çš„æç¤ºè¯ã€‚ä½†å› ä¸ºç”¨æˆ·è¾“å…¥å˜æ›´å¾ˆå¿«ï¼Œæœ€ç»ˆæ˜¾ç¤ºçš„æç¤ºè¯å¯èƒ½è¢«å»¶æœŸè¿”å›çš„è¯·æ±‚ç»“æœè¦†ç›–ã€‚


#### å¸¸è§è§£å†³æ€è·¯

ä¸€ä¸ªç®€å•çš„å¤„ç†ç«æ€é—®é¢˜çš„æ€è·¯ï¼šé€šè¿‡é—­åŒ…çš„ `active` æ ‡è®°æ¥è®©æ—§çš„è¯·æ±‚åœ¨ç»„ä»¶é‡æ¸²æŸ“æ—¶ä¸å†æ‰§è¡Œåç»­é€»è¾‘ã€‚

```tsx
useEffect(() => {
  let active = true

  const fetchData = async () => {
    const response = await fetch(`https://swapi.dev/api/people/${props.id}/`)
    const newData = await response.json()
    if (active) {
      setFetchedId(props.id)
      setData(newData)
    }
  }

  fetchData()

  return () => { active = false }
}, [props.id])
```

- æ¯æ¬¡å‘èµ·è¯·æ±‚éƒ½æœ‰ä¸€ä¸ªæ–°çš„ `active` è¢«åˆ›å»ºï¼Œåªæœ‰å½“ `active` ä¸º `true` æ‰ä¼šæ‰§è¡Œç½‘ç»œè¯·æ±‚çš„åç»­æ“ä½œã€‚
- å½“ç»„ä»¶é‡æ–°æ¸²æŸ“æˆ–è€…è¯´é¡µé¢çŠ¶æ€è¿‡æœŸçš„æ—¶å€™ `active` å˜æˆ `false`ï¼Œè¿™ä¸ª `false` ä½œä¸ºç½‘ç»œè¯·æ±‚çš„é—­åŒ…è¢«ç¼“å­˜åˆ°äº†å›è°ƒå‡½æ•°ä¸­ï¼Œä»è€Œé˜»æ­¢äº†è¿‡æœŸçš„åç»­æ“ä½œã€‚


å‚è€ƒé“¾æ¥ ğŸ”—
- [race condition](https://maxrozen.com/race-conditions-fetching-data-react-with-useeffect) 
- [åœ¨ Effect ä¸­è¿›è¡Œæ•°æ®è¯·æ±‚çš„æ›¿ä»£æ–¹æ¡ˆ ï½œ Reactå®˜æ–¹æ–‡æ¡£](https://zh-hans.react.dev/learn/synchronizing-with-effects#what-are-good-alternatives-to-data-fetching-in-effects)


<Callout type='info'>
React Query ä¼šæ ¹æ® `queryKey` ç¼“å­˜æ¯ä¸€æ¬¡è¯·æ±‚ã€‚å¦‚æœä½ èƒ½ä¿è¯æ¯ä¸€æ¬¡è¯·æ±‚çš„ `queryKey` æ˜¯å”¯ä¸€çš„ï¼Œé‚£ä¹ˆå°±ä¸ä¼šå‘ç”Ÿç«æ€é—®é¢˜ã€‚
</Callout>

## æŠ€å·§ç¯‡
åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸éœ€è¦æ ¹æ®ä¸åŒåœºæ™¯å¯¹æ¥å£è¯·æ±‚è¿›è¡Œæ›´ç»†è‡´çš„æ§åˆ¶ï¼Œæ¯”å¦‚ï¼šæ˜¯å¦è¯·æ±‚ã€è¯·æ±‚é¡ºåºã€æ˜¯å¦è½®è¯¢ç­‰ã€‚æœ¬æ–‡å°†æ·±å…¥ä»‹ç» useQuery åœ¨è¿™äº›é«˜çº§åœºæ™¯ä¸‹çš„ä½¿ç”¨æ–¹å¼ã€‚

### æ¡ä»¶æ€§è¯·æ±‚ï¼ˆConditional Queriesï¼‰

æœ‰æ—¶æˆ‘ä»¬å¸Œæœ›åªæœ‰åœ¨æ»¡è¶³æŸä¸ªæ¡ä»¶æ—¶æ‰å‘èµ·è¯·æ±‚ï¼Œä¾‹å¦‚æœç´¢å…³é”®è¯å­˜åœ¨æ—¶æ‰è¯·æ±‚æœç´¢ç»“æœã€‚

âš ï¸ é”™è¯¯ç¤ºèŒƒï¼ˆè¿å Hook è§„åˆ™ï¼‰ï¼š

```tsx
if (keyword) {
  useQuery({
    queryKey: ['search', keyword],
    queryFn
  })
}
```

âœ… æ­£ç¡®å†™æ³•ï¼šé€šè¿‡ enabled å‚æ•°æ§åˆ¶è¯·æ±‚æ˜¯å¦å¯ç”¨ã€‚

```tsx
useQuery({
  queryKey: ['search', keyword],
  queryFn,
  enabled: !!keyword // keyword å­˜åœ¨æ—¶æ‰è¯·æ±‚ å³ï¼šä»…å½“ `enabled` ä¸º `true` æ—¶ï¼Œquery æ‰ä¼šè¢«è§¦å‘ã€‚
})
```


### ä¾èµ–æ€§è¯·æ±‚ï¼ˆDependent Queriesï¼‰

æœ‰äº›è¯·æ±‚ä¾èµ–äºå¦ä¸€ä¸ªè¯·æ±‚çš„ç»“æœï¼Œæ¯”å¦‚æ ¹æ®ä¹¦åè·å–ä¹¦ç±ä¿¡æ¯ï¼Œå†æ ¹æ®ä¹¦ç± ID è·å–è¯„è®ºã€‚

âŒ ä¸æ¨èï¼šå°†å¤šä¸ªè¯·æ±‚å†™åœ¨ä¸€ä¸ª queryFn ä¸­ï¼ˆè€¦åˆæ€§é«˜ï¼‰

```tsx
useQuery({
  queryKey: ['book', 'comments', bookTitle],
  queryFn: async () => {
    const book = await fetchBook(bookTitle)
    const comments = await fetchBookComments(book.data.id)
    return { book, comments }
  }
})
```

âœ… æ¨èæ–¹å¼ï¼šæ‹†åˆ†ä¸ºå¤šä¸ª queryï¼Œå¹¶é€šè¿‡ enabled æ§åˆ¶è¯·æ±‚æ—¶æœº

```tsx
const useBookDetail = (bookTitle: string) =>
  useQuery({
    queryKey: ['book', bookTitle],
    queryFn: () => fetchBook(bookTitle),
    enabled: !!bookTitle
  })

const useBookComments = (bookId?: string) =>
  useQuery({
    queryKey: ['comments', bookId],
    queryFn: () => fetchBookComments(bookId!),
    enabled: !!bookId
  })

const useBookDetailAndComments = (bookTitle: string) => {
  const book = useBookDetail(bookTitle)
  const comments = useBookComments(book.data?.id)
  return { book, comments }
}
```

è¿™æ ·ä¸ä»…é™ä½äº†è€¦åˆï¼Œè¿˜èƒ½åˆ†åˆ«ç¼“å­˜å’Œå¤ç”¨æ¯ä¸ªè¯·æ±‚çš„æ•°æ®ã€‚



### è½®è¯¢ï¼ˆPollingï¼‰

å¦‚æœä½ éœ€è¦å®šæ—¶è¯·æ±‚æ•°æ®ï¼Œæ¯”å¦‚æ£€æµ‹æ”¯ä»˜æ˜¯å¦å®Œæˆï¼Œå¯ä»¥ä½¿ç”¨ `refetchInterval` å‚æ•°ã€‚

#### 1. ç®€å•è½®è¯¢ï¼š

è½®è¯¢é€šå¸¸ç”¨äºé‚£äº›éœ€è¦å®æ—¶æ€§åé¦ˆçš„åœºæ™¯ï¼Œæ¯”å¦‚æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å®Œæˆæ”¯ä»˜ã€‚

```tsx
useQuery({
  queryKey: ['list', { sort }],
  queryFn,
  refetchInterval: 5000, // æ¯ 5 ç§’è¯·æ±‚ä¸€æ¬¡
});
```

#### 2. æ¡ä»¶è½®è¯¢ï¼šä»…åœ¨æŸäº›çŠ¶æ€ä¸‹æŒç»­è½®è¯¢

`refetchInterval` ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚
æƒ³è±¡è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šå‰ç«¯é€šè¿‡è½®è¯¢æ¥å¾—çŸ¥ç”¨æˆ·æ˜¯å¦å®Œæˆæ”¯ä»˜ï¼Œç”¨æˆ·ä¸€æ—¦å®Œæˆæ”¯ä»˜è½®è¯¢å°±è¯¥åœæ­¢ã€‚

```tsx
useQuery({
  //...,
  refetchInterval: (query) => {
    if (query.state.data?.finished) {
      return false; // åœæ­¢è½®è¯¢
    }
    return 3000; // æ¯ 3 ç§’è¯·æ±‚ä¸€æ¬¡
  }
})
```

###  ğŸš€ å¹¶å‘è¯·æ±‚ï¼ˆParallel Queriesï¼‰

#### 1. Promise.all ç®€å•å®ç°ï¼ˆæ³¨æ„å¤±è´¥ä¼šä¸­æ–­æ‰€æœ‰è¯·æ±‚ï¼‰ï¼š


```tsx
const queryFn = async (bookId: string) => {
  const [book, comments] = await Promise.all([
    fetchBookDetail(bookId),
    fetchBookComments(bookId)
  ])

  return { book, comments }
}

useQuery({
  queryKey: ['bookWithComments', bookId],
  queryFn
})
```

<Callout type='warn' >
å½“ä¸€äº›ä¸šåŠ¡åœºæ™¯éœ€è¦å‰ç«¯å¹¶å‘è‹¥å¹²è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `queryFn` é‡ŒåŸºäº `Promise.all` æ¥å¹¶å‘è¯·æ±‚ã€‚
è¿™å¾ˆå¥½ï¼Œä½†ä¼šè®©ä¸¤ä¸ªè¯·æ±‚è€¦åˆåœ¨ä¸€èµ·ã€‚ä»»æ„è¯·æ±‚çš„å¤±è´¥éƒ½ä¼šå¯¼è‡´æ•´ä¸ªè¯·æ±‚å¤±è´¥ï¼Œä¸”åªæœ‰ä¸€ä¸ªç¼“å­˜ keyï¼Œä¸åˆ©äºç»†ç²’åº¦çš„æ§åˆ¶ç¼“å­˜ã€‚
</Callout>


##### 2. ä½¿ç”¨ `useQueries` å¹¶å‘å¤šä¸ªè¯·æ±‚ï¼Œæ”¯æŒæ›´ç»†ç²’åº¦æ§åˆ¶

```tsx
const ids = [1, 2, 3] // // åŸºäº ids å¹¶å‘è¯·æ±‚ï¼Œå¯ä»¥åŠ¨æ€æ§åˆ¶è¯·æ±‚æ•°é‡

const { data, pending } = useQueries({
  queries: ids.map((id) => ({
    queryKey: ['post', id],
    queryFn: () => fetchPost(id),
  })),
  combine: (results) => ({
    data: results.map((r) => r.data),
    pending: results.some((r) => r.isPending)
  })
})

```

<Callout type='warn' >
ä¸Šé¢çš„ä»£ç é€šè¿‡è°ƒç”¨ `useQuery` å¤šæ¬¡ï¼Œè¿™ä¹Ÿå¾ˆå¥½ï¼Œä½†ç¼ºç‚¹æ˜¯ä¸èƒ½åŠ¨æ€æ§åˆ¶è¯·æ±‚å¹¶å‘çš„æ•°é‡ã€‚
</Callout>



#### 3. å¤šè¯·æ±‚å¹¶èšåˆç»“æœç¤ºä¾‹ï¼š

å¦‚æœä½ æ˜ç¡®å¹¶å‘çš„è¯·æ±‚ä¹‹é—´å­˜åœ¨é€»è¾‘å…³è”ï¼Œæˆ–è€…éœ€è¦åŠ¨æ€æ§åˆ¶å¹¶å‘æ•°é‡ï¼Œæ›´æ¨èä½¿ç”¨ `useQueries`ã€‚
`useQueries` çš„ `queries` å‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„é‡Œçš„æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ª `useQuery` çš„é…ç½®å¯¹è±¡ã€‚
åŸºäº `combine` å¯ä»¥å®ç°æ›´å¤æ‚çš„èšåˆé€»è¾‘ã€‚


```tsx
const { bookDetail, bookComments, isDetailAndCommentPending } = useQueries({
  queries: [
    {
      queryKey: ['book', selectedBookId],
      queryFn: () => fetchBookDetail(selectedBookId!),
      enabled: !!selectedBookId
    },
    {
      queryKey: ['bookComments', selectedBookId],
      queryFn: () => fetchBookComments(selectedBookId!),
      enabled: !!selectedBookId
    }
  ],
  combine: ([bookDetail, bookComments]) => ({
    bookDetail,
    bookComments,
    isDetailAndCommentPending: bookDetail.isPending || bookComments.isPending
  })
})

```
