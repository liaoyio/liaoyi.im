---
title: æ¸²æŸ“ä¼˜åŒ–ä¸é”™è¯¯å¤„ç†
description: é€‚ç”¨äº React æ¡†æ¶çš„ TanStack Query æ¸²æŸ“ä¼˜åŒ–ä¸é”™è¯¯å¤„ç†ã€‚
date: 2025-05-28
tags: ['react-query', 'å¼‚æ­¥çŠ¶æ€ç®¡ç†']
author: liaoyi
series: react-query
seriesPart: 2
---

# æ¸²æŸ“ä¼˜åŒ–ä¸é”™è¯¯å¤„ç†

> æœ¬æ–‡ä»…é€‚ç”¨äº React æ¡†æ¶ï¼Œå…¶ä»–æ¡†æ¶è¯·å‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://tanstack.com/query/v5/docs/framework/react/guides/render-optimizations)ã€‚

---

## ä¸€ã€æ¸²æŸ“ä¼˜åŒ–

TanStack Query ä¼šè‡ªåŠ¨åº”ç”¨å¤šç§ä¼˜åŒ–ç­–ç•¥ï¼Œä»¥ç¡®ä¿ç»„ä»¶ä»…åœ¨â€œçœŸæ­£éœ€è¦â€æ—¶æ‰é‡æ–°æ¸²æŸ“ã€‚

### 1. ç»“æ„å…±äº«ï¼ˆStructural Sharingï¼‰

TanStack Query é€šè¿‡â€œç»“æ„å…±äº«â€æŠ€æœ¯ï¼Œå°½å¯èƒ½ä¿ç•™æ—§å¼•ç”¨ï¼Œå‡å°‘ diff å¸¦æ¥çš„ä¸å¿…è¦é‡æ¸²æŸ“ï¼š

- ç½‘ç»œè¯·æ±‚é€šå¸¸è¿”å›æ–° JSON å¯¹è±¡ï¼Œå¼•ç”¨å‘ç”Ÿå˜åŒ–ã€‚
- ä½†å¦‚æœæ•°æ®å†…å®¹æœªå˜ï¼ŒQuery ä¼šä¿ç•™åŸå§‹å¼•ç”¨ã€‚
- ä»…æ•°æ®éƒ¨åˆ†å˜åŠ¨æ—¶ï¼ŒQuery ä¼šåªæ›¿æ¢å‘ç”Ÿå˜åŒ–çš„é‚£ä¸€éƒ¨åˆ†å¼•ç”¨ã€‚

> âœ… è¦æ±‚ï¼š`queryFn` å¿…é¡»è¿”å› JSON å…¼å®¹å¯¹è±¡ã€‚

---

### 2. å¼•ç”¨ç¨³å®šæ€§ï¼ˆReferential Identityï¼‰

`useQuery` / `useMutation` ç­‰è¿”å›çš„æ•´ä½“å¯¹è±¡æ¯æ¬¡æ¸²æŸ“éƒ½ä¼šå˜åŒ–ï¼ˆéç¨³å®šå¼•ç”¨ï¼‰ï¼Œä½†ï¼š

- å…¶å†…éƒ¨çš„ `data` å±æ€§å°½é‡ä¿æŒå¼•ç”¨ç¨³å®šã€‚
- é¿å…æ— æ„ä¹‰çš„æ·±å±‚æ¯”è¾ƒå’Œç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚

---

### 3. è·Ÿè¸ªå±æ€§ï¼ˆTracked Propertiesï¼‰

TanStack Query ä½¿ç”¨ getter åŠ«æŒæŠ€æœ¯ï¼Œå¯¹è¿”å›å¯¹è±¡ä¸­çš„å±æ€§è¿›è¡Œâ€œä½¿ç”¨è¿½è¸ªâ€ï¼š

- ä»…åœ¨ç»„ä»¶å®é™…ä½¿ç”¨æŸå±æ€§å¹¶è¯¥å±æ€§å‘ç”Ÿå˜åŒ–æ—¶æ‰è§¦å‘æ›´æ–°ã€‚
- é¿å… `isFetching`, `isStale` ç­‰é¢‘ç¹å˜åŠ¨å±æ€§å¯¼è‡´ç»„ä»¶é‡æ¸²æŸ“ã€‚

âš ï¸ æ³¨æ„ï¼šæ­¤ä¼˜åŒ–ä»…å¯¹ä»¥ä¸‹å½¢å¼ç”Ÿæ•ˆï¼š

```tsx
const { isFetching } = useQuery(...); // âœ… å¯è¿½è¸ª
const rest = useQuery(...); const { isFetching } = rest; // âŒ ä¸å¯è¿½è¸ª
```

---

### 4. `select` ç²¾å‡†é€‰æ‹©æ¸²æŸ“æ•°æ®

é€šè¿‡ `select` å‚æ•°è‡ªå®šä¹‰ `data`ï¼Œå¯ç²¾ç»†æ§åˆ¶æ›´æ–°ï¼š

```ts
export const useTodos = (select) =>
  useQuery({ queryKey: ["todos"], queryFn: fetchTodos, select });

export const useTodoCount = () =>
  useTodos((data) => data.length);
```

- å½“ `todos.length` å‘ç”Ÿå˜åŒ–æ‰é‡æ–°æ¸²æŸ“ï¼›
- `todos` å†…éƒ¨å†…å®¹å˜åŒ–ä¸ä¼šè§¦å‘æ›´æ–°ã€‚

âš ï¸ æ³¨æ„äº‹é¡¹ï¼š

- `select` å‡½æ•°åœ¨â€œæ•°æ®å˜åŒ–â€æˆ–â€œå‡½æ•°å¼•ç”¨å˜åŒ–â€æ—¶æ‰é‡æ–°æ‰§è¡Œï¼›
- å¦‚æœç›´æ¥å†…è”å‡½æ•°ï¼Œæ¸²æŸ“æ—¶æ¯æ¬¡éƒ½ä¼šè§¦å‘æ‰§è¡Œï¼Œåº”ä½¿ç”¨ `useCallback` åŒ…è£¹æˆ–å¤–æå‡½æ•°ï¼š

```ts
// æ¨èåšæ³• 1ï¼šuseCallback åŒ…è£¹
export const useTodoCount = () =>
  useTodos(useCallback((data) => data.length, []));

// æ¨èåšæ³• 2ï¼šæå–ä¸ºç¨³å®šå¼•ç”¨
const selectTodoCount = (data) => data.length;
export const useTodoCount = () => useTodos(selectTodoCount);
```

---

## äºŒã€é”™è¯¯å¤„ç†

### 1. é¿å…åœ¨ `queryFn` ä¸­ try-catch é”™è¯¯

```ts
const fetchTodos = async () => {
  try {
    return await axios.get("/todos"); // âš ï¸ é”™è¯¯å†™æ³•
  } catch (err) {
    return []; // âŒ React Query æ— æ³•æ„ŸçŸ¥é”™è¯¯
  }
};
```

> âœ… æ­£ç¡®æ–¹å¼ï¼šè®©é”™è¯¯è‡ªç„¶æŠ›å‡ºï¼ŒReact Query ä¼šè‡ªåŠ¨æ¥æ”¶å’Œå¤„ç†ã€‚

---

### 2. ç»„ä»¶çº§é”™è¯¯å¤„ç†

é€‚ç”¨äºå±€éƒ¨å±•ç¤ºé”™è¯¯ï¼š

```tsx
const { isError, error } = useQuery(...);

if (isError) {
  return <div>Error: {error.message}</div>;
}
```

---

### 3. å…¨å±€é”™è¯¯å¤„ç†ï¼ˆError Boundaryï¼‰

é€‚ç”¨äºé¡µé¢çº§é”™è¯¯å›é€€ï¼Œéœ€è¦é…åˆ `throwOnError: true`ï¼š

```tsx
<ErrorBoundary fallback={<ErrorFallback />}>
  <QueryClientProvider client={queryClient}>
    <App />
  </QueryClientProvider>
</ErrorBoundary>
```

```ts
useQuery({
  queryKey: [...],
  queryFn,
  throwOnError: true,
});
```

---

## ä¸‰ã€å°è´´å£«è¡¥å……

- é…ç½® `retry` é€‰é¡¹æ§åˆ¶é”™è¯¯é‡è¯•æ¬¡æ•°ï¼Œé¿å…åˆ é™¤ç±»è¯·æ±‚è‡ªåŠ¨é‡è¯•ï¼š

```ts
useQuery({
  queryKey: ["todos"],
  queryFn: fetchTodos,
  retry: false, // ç¦æ­¢é‡è¯•
});
```

- å…¨å±€é”™è¯¯æç¤ºå¯ä½¿ç”¨ `queryClient.setDefaultOptions({...})` ç»Ÿä¸€é…ç½®ã€‚

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [TanStack å®˜æ–¹æ–‡æ¡£ï¼šRender Optimizations](https://tanstack.com/query/v5/docs/framework/react/guides/render-optimizations)
- [TanStack å®˜æ–¹æ–‡æ¡£ï¼šError Handling](https://tanstack.com/query/v5/docs/framework/react/guides/errors)
